<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>

<style>
body { font-family:tahoma; background:#f2f4f7; margin:0; }
.container { max-width:420px; margin:auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 10px #0002; }
h2 { text-align:center; }
label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea, button { width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
input.error, select.error, textarea.error { border-color:red; background:#ffecec; }
button { background:#0a7cff; color:#fff; border:0; margin-top:15px; cursor:pointer; }
button:disabled { background:#999; cursor:not-allowed; }
#msg { text-align:center; margin-top:10px; font-weight:bold; }
.hidden { display:none; }

/* top info */
#topInfo { background:#eef; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
#topInfo span { font-weight:bold; }
#editBtn { width:auto; padding:6px 10px; font-size:14px; background:#666; }
#cityEdit { width:auto; padding:6px 10px; font-size:14px; }
</style>
</head>

<body>
<div class="container">

<!-- تسجيل الدخول -->
<div id="login">
  <h2>تسجيل الدخول</h2>
  <label>اسم المندوب *</label>
  <input id="repName">
  <label>المدينة *</label>
  <input id="city">
  <button onclick="saveLogin()">دخول</button>
</div>

<!-- الفورم -->
<div id="formBox" class="hidden">

  <div id="topInfo">
    <span>المندوب:</span> <span id="repShow"></span> |
    <span>المدينة:</span> <span id="cityShow"></span>
    <input id="cityEdit" class="hidden">
    <button id="editBtn" onclick="toggleEdit()">تعديل</button>
  </div>

  <h2>MAWARAN CO</h2>

  <label>هل يمتلك زيت ريماكس *</label>
  <select id="useOil">
    <option value="">اختر</option>
    <option>نعم</option>
    <option>لا</option>
  </select>

  <label>الاسم التجاري *</label>
  <input id="tradeName">

  <label>اسم المالك *</label>
  <input id="ownerName">

  <label>العنوان *</label>
  <input id="address">

  <label>رقم الهاتف *</label>
  <input id="phone" inputmode="numeric">

  <label>الفئة *</label>
  <select id="category">
    <option value="">اختر</option>
    <option>كراج</option>
    <option>جملة</option>
    <option>مفرد</option>
  </select>

  <label>ملاحظة</label>
  <textarea id="note"></textarea>

  <label>التقييم *</label>
  <select id="rate">
    <option value="">اختر</option>
    <option value="1">⭐</option>
    <option value="2">⭐⭐</option>
    <option value="3">⭐⭐⭐</option>
    <option value="4">⭐⭐⭐⭐</option>
    <option value="5">⭐⭐⭐⭐⭐</option>
  </select>

  <label>كل كم يوم زيارة *</label>
  <input id="visitDays" inputmode="numeric">

  <label>نوع الزيت</label>
  <input id="oilType">

  <label>درجة الزيت</label>
  <input id="oilGrade">

  <label>المسافة</label>
  <select id="oilDistance">
    <option value="">اختر</option>
    <option>3 كم</option>
    <option>5 كم</option>
    <option>10 كم</option>
    <option>15 كم</option>
  </select>

  <label>سعر اللتر</label>
  <input id="oilPrice" inputmode="numeric">

  <label>صورة المتجر *</label>
  <input type="file" id="imageInput" accept="image/*" capture="environment">

  <button id="sendBtn" onclick="send()">إرسال</button>
  <div id="msg"></div>
</div>
</div>

<script>
const URL = "PUT_YOUR_WEBAPP_URL_HERE";
let uploadedImageData = "";
let isSending = false;

/* تسجيل الدخول */
if(localStorage.repName){
  login.classList.add("hidden");
  formBox.classList.remove("hidden");
  repShow.textContent = localStorage.repName;
  cityShow.textContent = localStorage.city;
  cityEdit.value = localStorage.city;
}

function saveLogin(){
  if(!repName.value || !city.value) return;
  localStorage.repName = repName.value;
  localStorage.city = city.value;
  location.reload();
}

let editMode=false;
function toggleEdit(){
  editMode = !editMode;
  cityShow.classList.toggle("hidden", editMode);
  cityEdit.classList.toggle("hidden", !editMode);
  editBtn.textContent = editMode ? "حفظ" : "تعديل";
  if(!editMode){
    localStorage.city = cityEdit.value;
    cityShow.textContent = cityEdit.value;
  }
}

/* ضغط الصورة */
function resizeImage(file, maxW, maxH, cb){
  const r = new FileReader();
  r.onload = e=>{
    const img = new Image();
    img.onload = ()=>{
      let w = img.width, h = img.height;
      if(w > maxW){ h *= maxW / w; w = maxW; }
      if(h > maxH){ w *= maxH / h; h = maxH; }
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      cb(c.toDataURL("image/jpeg",0.7));
    };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

imageInput.onchange = ()=>{
  if(imageInput.files[0])
    resizeImage(imageInput.files[0],800,800,d=>uploadedImageData=d);
};

/* الإرسال */
function send(){
  if(isSending) return;

  const btn = sendBtn;
  const req = [useOil, tradeName, ownerName, address, phone, category, rate, visitDays];
  let ok = true;

  req.forEach(f=>{
    f.classList.remove("error");
    if(!f.value){ f.classList.add("error"); ok=false; }
  });

  if(!uploadedImageData){ imageInput.classList.add("error"); ok=false; }

  if(!ok){
    msg.textContent="❌ أكمل الحقول المطلوبة";
    return;
  }

  isSending = true;
  btn.disabled = true;
  btn.textContent = "جاري الإرسال...";
  msg.textContent = "جاري الإرسال...";

  navigator.geolocation.getCurrentPosition(pos=>{
    fetch(URL,{
      method:"POST",
      body:JSON.stringify({
        repName: localStorage.repName,
        city: localStorage.city,
        tradeName: tradeName.value,
        ownerName: ownerName.value,
        useOil: useOil.value,
        address: address.value,
        phone: phone.value,
        category: category.value,
        note: note.value,
        rate: rate.value,
        visitDays: visitDays.value,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        oilType: oilType.value,
        oilGrade: oilGrade.value,
        oilDistance: oilDistance.value,
        oilPrice: oilPrice.value,
        image: uploadedImageData
      })
    })
    .then(r=>r.json())
    .then(()=>msg.textContent="✅ تم الإرسال بنجاح")
    .catch(()=>msg.textContent="❌ خطأ في الإرسال")
    .finally(()=>{
      isSending=false;
      btn.disabled=false;
      btn.textContent="إرسال";
    });
  });
}
</script>
</body>
</html>
