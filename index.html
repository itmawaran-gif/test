<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWARAN Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; background: #f0f9ff; margin: 0; transition: all 0.3s; }
        
        #splashScreen {
            position: fixed; inset: 0; background: #e0f2fe; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #loginPage, #dashboard { display: none; }
        
        .custom-card { 
            background: linear-gradient(135deg, #b9f3f7, #ffffff); 
            border: 2px solid #ffffff; 
            border-radius: 2rem; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .gauge-svg { width: 100%; height: auto; }
        .needle {
            transform-origin: 50px 50px;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(0deg); 
        }

        .slider-track {
            height: 10px; background: #e2e8f0; border-radius: 999px; position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); margin-top: 4px;
        }
        .slider-fill {
            height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 999px;
            position: absolute; left: 0; top: 0;
        }
        .slider-thumb {
            position: absolute; right: -8px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; background: #ffffff; border: 2px solid #cbd5e1;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .slider-label {
            position: absolute; top: -22px; right: -12px; background: white;
            padding: 1px 6px; border-radius: 8px; font-size: 9px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;
        }

        .input-soft { background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 9999px; padding: 0.8rem; text-align: center; width: 100%; outline: none; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± */
        .toast-enter { transform: translateY(-100%); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="p-4 relative">

<div id="notificationToast" class="fixed top-4 left-1/2 -translate-x-1/2 w-11/12 max-w-sm bg-sky-900 text-white p-4 rounded-2xl shadow-2xl z-50 flex justify-between items-center transition-all duration-500 toast-enter">
    <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ””</span>
        <span id="notifMessage" class="font-bold text-sm"></span>
    </div>
    <button onclick="closeNotification()" class="text-sky-300 font-bold text-xl">&times;</button>
</div>

<div id="splashScreen">
    <div class="custom-card p-10 mb-4">
        <h1 class="text-3xl font-bold text-sky-900 tracking-widest">MAWARAN</h1>
    </div>
    <div class="text-sky-900 font-bold animate-pulse" data-i18n="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</div>
</div>

<div class="max-w-md mx-auto space-y-4">
    
    <div id="loginPage" class="mt-10 space-y-6">
        <div class="custom-card p-4 text-center text-3xl font-bold text-sky-900 tracking-tighter">MAWARAN CO .</div>
        <div class="px-6 space-y-4 text-center">
            <p class="font-bold text-sky-900 text-xl" data-i18n="agent">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</p>
            <input type="text" id="user" class="input-soft shadow-inner">
            <p class="font-bold text-sky-900 text-xl" data-i18n="password">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>
            <input type="password" id="pass" class="input-soft shadow-inner">
            <button onclick="login()" id="loginBtn" class="w-full bg-sky-600 text-white py-4 rounded-full font-bold shadow-lg mt-4" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="dashboard" class="space-y-4">
        <div class="custom-card py-4 text-center text-3xl font-bold text-sky-900 tracking-tighter">MAWARAN CO .</div>

        <div class="grid grid-cols-2 gap-4">
            <div class="custom-card p-4 flex flex-col items-center justify-center cursor-pointer hover:shadow-lg transition-shadow" onclick="showGaugeModal()">
                <svg viewBox="0 0 100 55" class="gauge-svg">
                    <defs>
                        <linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ef4444" />
                            <stop offset="50%" style="stop-color:#facc15" />
                            <stop offset="100%" style="stop-color:#22c55e" />
                        </linearGradient>
                    </defs>
                    <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e2e8f0" stroke-width="6" stroke-linecap="round"/>
                    <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="url(#gaugeGrad)" stroke-width="6" stroke-linecap="round"/>
                    <line id="needle" x1="50" y1="50" x2="15" y2="50" stroke="#38bdf8" stroke-width="3" stroke-linecap="round" class="needle"/>
                    <circle cx="50" cy="50" r="3" fill="#ffffff" stroke="#38bdf8" stroke-width="1.5"/>
                </svg>
                <div class="text-2xl font-bold text-sky-900 mt-2"><span id="perfVal">0</span> %</div>
                <div class="text-[10px] text-sky-500 mt-1" data-i18n="clickDetails">Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„</div>
            </div>

            <div class="custom-card p-4 space-y-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sky-900 text-sm" data-i18n="salary">Ø§Ù„Ø±Ø§ØªØ¨</span>
                    <span class="bg-sky-200/50 px-2 py-0.5 rounded-full text-[10px] font-bold shadow-inner" id="salary">0 IQD</span>
                </div>
                
                <div class="flex flex-col">
                    <span class="font-bold text-[11px] text-sky-900" data-i18n="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                    <span class="opacity-50 text-[9px] font-bold leading-none" id="sGoalMax">Goal: 10000$</span>
                    <div class="slider-track">
                        <div id="salesBar" class="slider-fill" style="width: 0%">
                            <div class="slider-label" id="salesVal">0$</div>
                            <div class="slider-thumb"></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col pt-1">
                    <span class="font-bold text-[11px] text-sky-900" data-i18n="collection">ØªØ­ØµÙŠÙ„</span>
                    <span class="opacity-50 text-[9px] font-bold leading-none" id="cGoalMax">Goal: 10000$</span>
                    <div class="slider-track">
                        <div id="collBar" class="slider-fill" style="width: 0%">
                            <div class="slider-label" id="collVal">0$</div>
                            <div class="slider-thumb"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="custom-card p-4 flex items-center">
            <div class="text-md font-bold text-sky-900 w-24 leading-tight" data-i18n="monthGoal">Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±</div>
            <div class="flex-1 px-4">
                <div class="slider-track">
                    <div id="mGoalBar" class="slider-fill" style="width: 0%">
                        <div class="slider-label" id="mGoalVal">0$</div>
                        <div class="slider-thumb"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative custom-card">
            <select id="custSelect" onchange="handleSelectChange(this)" class="w-full p-4 bg-transparent text-2xl font-bold text-sky-900 outline-none cursor-pointer text-center">
                <option value="" data-i18n="selectCust">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</option>
            </select>
            <div class="absolute left-10 top-1/2 -translate-y-1/2 pointer-events-none text-sky-900">â–¼</div>
        </div>

        <div class="custom-card p-5">
            <h3 class="text-center text-2xl font-bold border-b-2 border-sky-100 pb-2 mb-4 text-sky-900 tracking-widest" data-i18n="todayColl">ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div id="todayList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            <div class="flex justify-between items-center mt-6 pt-2 border-t-2 border-sky-100">
                <div class="bg-white/50 px-8 py-1 rounded-full border border-sky-100 font-bold text-2xl text-sky-900" id="dayTotal">$ 0</div>
                <div class="bg-white/50 px-6 py-1 rounded-full border border-sky-100 font-bold text-xl text-sky-900" data-i18n="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
            </div>
        </div>

        <button onclick="toggleLanguage()" class="w-full py-3 bg-white/50 rounded-full font-bold text-sky-900 shadow-sm border border-white flex justify-center items-center gap-2">
            ğŸŒ <span id="langBtnText">Ú©ÙˆØ±Ø¯ÛŒ</span>
        </button>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-sky-900/20 backdrop-blur-sm hidden flex items-center justify-center p-6 z-50">
    <div class="custom-card w-full max-w-sm p-6 space-y-4">
        <h2 id="modalTitle" class="text-center text-2xl font-bold text-sky-900 border-b pb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <div class="space-y-3">
            <p class="text-center font-bold text-sky-800" data-i18n="amtD">Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙˆÙ„Ø§Ø± $</p>
            <input type="number" id="amtD" class="input-soft text-lg font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="amtIQ">Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙŠÙ†Ø§Ø±</p>
            <input type="number" id="amtIQ" oninput="calcExchange()" class="input-soft text-lg font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="rate">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</p>
            <input type="number" id="rate" value="0"  class="input-soft text-sm font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="note">Ù…Ù„Ø§Ø­Ø¸Ø©</p>
            <input type="text" id="note" class="input-soft">
            <button onclick="sendData()" id="sendBtn" class="w-full py-4 bg-sky-400/80 text-sky-900 text-3xl font-bold rounded-full shadow-lg mt-4" data-i18n="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
            <button onclick="closeModal()" class="w-full text-xs text-gray-400 mt-2" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="gaugeModal" class="fixed inset-0 bg-sky-900/40 backdrop-blur-sm hidden flex items-center justify-center p-6 z-50">
    <div class="custom-card w-full max-w-sm p-6 space-y-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-center text-2xl font-bold text-sky-900 border-b pb-2" data-i18n="perfDetails">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
        
        <div class="space-y-3 bg-white/50 p-4 rounded-xl border border-sky-100">
            <div class="flex justify-between font-bold text-sky-800 border-b border-sky-50 pb-1">
                <span data-i18n="attendance">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</span> <span id="m_attendance" class="text-sky-600">0</span>
            </div>
            <div class="flex justify-between font-bold text-sky-800 border-b border-sky-50 pb-1">
                <span data-i18n="visitsMonth">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±</span> <span id="m_visitsMonth" class="text-sky-600">0</span>
            </div>
            <div class="flex justify-between font-bold text-sky-800 border-b border-sky-50 pb-1">
                <span data-i18n="visitsDay">Ù…Ø¹Ø¯Ù„ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span> <span id="m_visitsDay" class="text-sky-600">0</span>
            </div>
            <div class="flex justify-between font-bold text-sky-800 pb-1">
                <span data-i18n="visitTime">Ù…Ø¹Ø¯Ù„ ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span> <span id="m_visitTime" class="text-sky-600">0</span>
            </div>
        </div>

        <h3 class="text-center text-xl font-bold text-sky-900 mt-4 bg-sky-100 rounded-lg py-1" data-i18n="topAgents">Ø£ÙØ¶Ù„ 3 Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h3>
        <div id="topAgentsList" class="space-y-2 bg-gradient-to-r from-sky-50 to-white p-4 rounded-xl border border-sky-200 shadow-sm">
            </div>

        <button onclick="closeGaugeModal()" class="w-full py-3 bg-sky-200 text-sky-900 font-bold rounded-full shadow mt-4" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqJ803zmy6_4F8ZTrx7S4SV-K0tAQA1cxRWuuqxODplfwSsXogYvax62Fvgj5jP-zD/exec";
let agent = null;
let notifInterval;

const i18n = {
    ar: {
        loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...",
        agent: "Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨",
        password: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ",
        loginBtn: "Ø¯Ø®ÙˆÙ„",
        salary: "Ø§Ù„Ø±Ø§ØªØ¨",
        sales: "Ù…Ø¨ÙŠØ¹Ø§Øª",
        collection: "ØªØ­ØµÙŠÙ„",
        monthGoal: "Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±",
        selectCust: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨",
        todayColl: "ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…",
        total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
        amtD: "Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙˆÙ„Ø§Ø± $",
        amtIQ: "Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙŠÙ†Ø§Ø±",
        rate: "Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù",
        note: "Ù…Ù„Ø§Ø­Ø¸Ø©",
        sendBtn: "Ø§Ø±Ø³Ø§Ù„",
        cancel: "Ø¥Ù„ØºØ§Ø¡",
        clickDetails: "Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„",
        perfDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡",
        attendance: "Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±",
        visitsMonth: "Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±",
        visitsDay: "Ù…Ø¹Ø¯Ù„ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…",
        visitTime: "Ù…Ø¹Ø¯Ù„ ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
        topAgents: "Ø£ÙØ¶Ù„ 3 Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†",
        close: "Ø¥ØºÙ„Ø§Ù‚",
        langName: "Ú©ÙˆØ±Ø¯ÛŒ"
    },
    ku: {
        loading: "Ù†ÙˆÛ Ø¯Û•Ú©Ø±ÛØªÛ•ÙˆÛ•...",
        agent: "Ù†ÙˆÛÙ†Û•Ø±",
        password: "ØªÛÙ¾Û•Ú•Û•ÙˆØ´Û•",
        loginBtn: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•",
        salary: "Ù…ÙˆÙˆÚ†Û•",
        sales: "ÙØ±Û†Ø´ØªÙ†",
        collection: "Ú©Û†Ú©Ø±Ø¯Ù†Û•ÙˆÛ•",
        monthGoal: "Ø¦Ø§Ù…Ø§Ù†Ø¬ÛŒ Ù…Ø§Ù†Ú¯",
        selectCust: "Ú©Ú•ÛŒØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•",
        todayColl: "Ú©Û†Ú©Ø±Ø§ÙˆÛ•ÛŒ Ø¦Û•Ù…Ú•Û†",
        total: "Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ",
        amtD: "Ø¨Ú• Ø¨Û• Ø¯Û†Ù„Ø§Ø± $",
        amtIQ: "Ø¨Ú• Ø¨Û• Ø¯ÛŒÙ†Ø§Ø±",
        rate: "Ù†Ø±Ø®ÛŒ Ø¦Ø§ÚµÙˆÚ¯Û†Ú•",
        note: "ØªÛØ¨ÛŒÙ†ÛŒ",
        sendBtn: "Ù†Ø§Ø±Ø¯Ù†",
        cancel: "Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•",
        clickDetails: "Ø¨Û† ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ú©Ø±ØªÛ• Ø¨Ú©Û•",
        perfDetails: "ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ø¦Ø§Ø³Øª",
        attendance: "Ú•ÛÚ˜Û•ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†",
        visitsMonth: "Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ Ù…Ø§Ù†Ú¯",
        visitsDay: "ØªÛÚ©Ú•Ø§ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ Ú•Û†Ú˜Ø§Ù†Û•",
        visitTime: "ØªÛÚ©Ú•Ø§ÛŒ Ú©Ø§ØªÛŒ Ø³Û•Ø±Ø¯Ø§Ù†",
        topAgents: "Ø¨Ø§Ø´ØªØ±ÛŒÙ† 3 Ù†ÙˆÛÙ†Û•Ø±",
        close: "Ø¯Ø§Ø®Ø³ØªÙ†",
        langName: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
    }
};

let currentLang = localStorage.getItem('mawar_lang') || 'ar';

function applyLanguage() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir = (currentLang === 'ar' || currentLang === 'ku') ? 'rtl' : 'ltr';
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.innerText = i18n[currentLang][key];
    });
    
    document.getElementById('langBtnText').innerText = i18n[currentLang].langName;
}

function toggleLanguage() {
    currentLang = currentLang === 'ar' ? 'ku' : 'ar';
    localStorage.setItem('mawar_lang', currentLang);
    applyLanguage();
}

window.onload = () => {
    applyLanguage(); 
    const saved = localStorage.getItem('mawar_session');
    if(saved) {
        const d = JSON.parse(saved);
        performLogin(d.u, d.p, true);
    } else {
        setTimeout(() => {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }, 1000);
    }
};

async function performLogin(u, p, isAuto) {
    try {
        const r = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
        const res = await r.json();
        if(res.success) {
            agent = res.data;
            localStorage.setItem('mawar_session', JSON.stringify({u, p}));
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateUI();
            loadCustomers();
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            checkNotification(); // Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            if(notifInterval) clearInterval(notifInterval);
            notifInterval = setInterval(checkNotification, 2 * 60 * 60 * 1000); // ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ†
            
        } else {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }
    } catch(e) { document.getElementById('splashScreen').style.display = 'none'; }
}

function updateUI() {
    const needle = document.getElementById('needle');
    const perfDisplay = document.getElementById('perfVal');
    const targetPerf = Math.round(agent.perf * 100); 

    needle.style.transition = "none"; 
    needle.style.transform = "rotate(0deg)";
    perfDisplay.innerText = "0";

    requestAnimationFrame(() => {
        setTimeout(() => {
            needle.style.transition = "transform 1.5s cubic-bezier(0.4, 0, 0.2, 1)";
            needle.style.transform = "rotate(180deg)";
            
            let tempVal = 0;
            let upInterval = setInterval(() => {
                if(tempVal >= 100) {
                    clearInterval(upInterval);
                } else {
                    tempVal += 2;
                    perfDisplay.innerText = tempVal;
                }
            }, 10);

            setTimeout(() => {
                const targetRotation = targetPerf * 1.8;
                needle.style.transform = `rotate(${targetRotation}deg)`;
                perfDisplay.innerText = targetPerf;
            }, 1500); 
        }, 100);
    });

    document.getElementById('salary').innerText = agent.salary.toLocaleString() + " DQ";
    setSlider('salesBar', 'salesVal', agent.sales, agent.sGoal || 10000);
    setSlider('collBar', 'collVal', agent.coll, agent.cGoal || 10000);
    setSlider('mGoalBar', 'mGoalVal', agent.mGoal, agent.tGoal || 10000);
    
    document.getElementById('sGoalMax').innerText = "Goal: " + (agent.sGoal || 10000) + "$";
    document.getElementById('cGoalMax').innerText = "Goal: " + (agent.cGoal || 10000) + "$";
    loadToday();
}

function setSlider(barId, valId, val, max) {
    const pct = Math.min((val / max) * 100, 100);
    document.getElementById(barId).style.width = pct + "%";
    document.getElementById(valId).innerText = val + "$";
}

async function loadCustomers() {
    const r = await fetch(`${SCRIPT_URL}?action=getCustomers&agent=${agent.name}`);
    const data = await r.json();
    const sel = document.getElementById('custSelect');
    sel.innerHTML = `<option value="">${i18n[currentLang].selectCust}</option>`;
    data.forEach(c => {
        let opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
    });
}

function handleSelectChange(select) {
    if(select.value) {
        document.getElementById('modalTitle').innerText = select.value;
        document.getElementById('modal').classList.remove('hidden');
    }
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('custSelect').value = "";
}

function calcExchange() {
    const iq = document.getElementById('amtIQ').value;
    const rate = document.getElementById('rate').value || 0;
    if(iq) document.getElementById('amtD').value = (iq / rate).toFixed(2);
}

async function loadToday() {
    const r = await fetch(`${SCRIPT_URL}?action=getToday&agent=${agent.name}`);
    const data = await r.json();
    const list = document.getElementById('todayList');
    let total = 0; list.innerHTML = "";
    data.forEach(i => {
        total += parseFloat(i.amt);
        list.innerHTML += `
            <div class="flex justify-between items-center bg-white/60 p-2 rounded-2xl border border-sky-900/10 mb-2 shadow-sm">
                <div class="w-24 text-center font-bold border-r-2 border-sky-100 text-lg">$ ${i.amt}</div>
                <div class="flex-1 text-center font-bold text-sky-900 text-sm">${i.cust}</div>
            </div>`;
    });
    document.getElementById('dayTotal').innerText = "$ " + total;
}

async function login() { performLogin(document.getElementById('user').value, document.getElementById('pass').value, false); }

async function sendData() {
    const btn = document.getElementById('sendBtn');
    btn.disabled = true; btn.innerText = "...";
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙ‚Ø·: ÙØµÙ„ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø¹Ù„Ø§Ù…Ø© "-" ÙˆØ£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    const fullCustomerText = document.getElementById('modalTitle').innerText;
    const cleanCustomerName = fullCustomerText.split('-')[0].trim();

    const payload = {
        agent: agent.name,
        customer: cleanCustomerName,
        amount: document.getElementById('amtD').value,
        amountIQD: document.getElementById('amtIQ').value, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±
        rate: document.getElementById('rate').value,       // Ø¥Ø¶Ø§ÙØ© Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
        note: document.getElementById('note').value
    };
    
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert(currentLang === 'ar' ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ù†ÛØ±Ø¯Ø±Ø§");
        closeModal();
        loadToday();
        
        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
        document.getElementById('amtD').value = '';
        document.getElementById('amtIQ').value = '';
        document.getElementById('note').value = '';
    } catch(e) { 
        alert("Error"); 
    }
    
    btn.disabled = false; btn.innerText = i18n[currentLang].sendBtn;
}

// ----------------- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -----------------

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒÙŠØ¬
function showGaugeModal() {
    if(!agent) return;
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
    document.getElementById('m_attendance').innerText = agent.attendance || "0";
    document.getElementById('m_visitsMonth').innerText = agent.visitsMonth || "0";
    document.getElementById('m_visitsDay').innerText = agent.visitsDay || "0";
    document.getElementById('m_visitTime').innerText = agent.visitTime || "0";
    
    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø£ÙØ¶Ù„ 3 Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
    const list = document.getElementById('topAgentsList');
    list.innerHTML = "";
    if(agent.topAgents && agent.topAgents.length > 0) {
        agent.topAgents.forEach((a, index) => {
            let medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : "ğŸ¥‰";
            list.innerHTML += `
                <div class="flex justify-between items-center border-b border-sky-100 last:border-0 py-1">
                    <span class="font-bold text-sky-900">${medal} ${a.name}</span>
                    <span class="bg-sky-200 text-sky-900 px-2 rounded font-bold text-sm">${a.rating}</span>
                </div>`;
        });
    } else {
        list.innerHTML = `<div class="text-center text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
    }

    document.getElementById('gaugeModal').classList.remove('hidden');
}

function closeGaugeModal() {
    document.getElementById('gaugeModal').classList.add('hidden');
}

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ¹Ø±Ø¶Ù‡
async function checkNotification() {
    try {
        const r = await fetch(`${SCRIPT_URL}?action=getNotification`);
        const res = await r.json();
        if(res.msg && res.msg.toString().trim() !== "") {
            document.getElementById('notifMessage').innerText = res.msg;
            const toast = document.getElementById('notificationToast');
            toast.classList.remove('toast-enter');
            toast.classList.add('toast-active');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°ÙÙ‡ Ù„ÙŠØ¨Ù‚Ù‰ Ø¸Ø§Ù‡Ø±Ø§Ù‹ Ø­ØªÙ‰ ÙŠØºÙ„Ù‚Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            setTimeout(closeNotification, 10000);
        }
    } catch(e) { console.error("Notification Error", e); }
}

function closeNotification() {
    const toast = document.getElementById('notificationToast');
    toast.classList.remove('toast-active');
    toast.classList.add('toast-enter');
}
</script>
</body>
</html>



