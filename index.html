<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>
<style>
    body { font-family:tahoma; background:#f2f4f7; margin:0; padding: 10px; }
    .container { max-width:420px; margin:auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 10px #0002; position: relative; }
    
    #securityModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f4f7; display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .security-content { background: #fff; padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

    #appModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .modal-content { background: #fff; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px; }
    .modal-content h3 { margin-top: 0; color: #333; }
    .modal-content p { font-size: 14px; color: #666; margin-bottom: 20px; }
    #openAppBtn { background: #28a745; color: #fff; border: 0; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }

    .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f4f7; z-index: 9990; overflow-y: auto; display: none; padding-bottom: 20px; }
    .modal-header { background: #0a7cff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 9991; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .modal-header h3 { margin: 0; font-size: 18px; }
    .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
    
    .details-box { background: white; margin: 15px; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .loader { text-align: center; margin-top: 50px; font-weight: bold; color: #555; }

    .lang-switcher { margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; text-align: center; }
    .lang-switcher select { width: auto; padding: 8px 15px; font-size: 14px; cursor: pointer; border-radius: 20px; background: #f8f9fa; border: 1px solid #ddd; }
    h2 { text-align:center; color: #333; margin-bottom: 20px; }
    label { display:block; margin-top:10px; font-weight:bold; font-size: 14px; color: #444; }
    input, select, textarea, button { width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid #ccc; font-size:16px; box-sizing: border-box; }
    input:disabled, select:disabled, textarea:disabled { background: #e9ecef; color: #666; cursor: not-allowed; }
    
    button { background:#0a7cff; color:#fff; border:0; margin-top:15px; cursor:pointer; font-weight: bold; }
    button:disabled { background:#999 !important; cursor:not-allowed; opacity: 0.6; }
    #msg { text-align:center; margin-top:10px; font-weight:bold; font-size: 14px; }
    .hidden { display:none !important; }
    
    .visit-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; flex-direction: column; }
    #startVisitBtn { width: 90px; height: 90px; border-radius: 50%; background: #28a745; color: white; border: none; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: 0.3s; }
    #startVisitBtn.active { background: #dc3545; animation: pulse 1.5s infinite; }
    #cancelVisitBtn { width: auto; padding: 6px 12px; background: #6c757d; font-size: 11px; margin-top: 5px; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav-tabs button { margin-top: 0; background: #eee; color: #333; flex: 1; font-size: 14px; border: 1px solid #ddd; }
    .nav-tabs button.active { background: #0a7cff; color: white; border-color: #0a7cff; }
    #timerDisplay { text-align: center; font-size: 22px; font-weight: bold; color: #dc3545; font-family: monospace; margin-bottom: 10px; }

    .client-selection-group { display: flex; gap: 5px; align-items: center; margin-top: 4px; }
    #reg_daySelect { width: 35%; padding: 10px 5px; font-size: 14px; }
    #reg_clientName { width: 65%; }
    #showDetailsBtn { background: #17a2b8; width: auto; padding: 10px 15px; margin-top: 0; font-size: 14px; }

    /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙÙ‚ÙŠ Ù„Ø­Ù‚Ù„ÙŠÙ† Ø¬Ù†Ø¨Ø§Ù‹ Ø¥Ù„Ù‰ Ø¬Ù†Ø¨ */
    .two-col-group { display: flex; gap: 10px; margin-top: 10px; }
    .two-col-group .col { flex: 1; }
    .two-col-group .col label { margin-top: 0; font-size: 13px; }
    .two-col-group .col select { font-size: 14px; padding: 8px 6px; }
</style>
</head>
<body>

<div id="securityModal">
    <div class="security-content">
        <h3>Ù†Ø¸Ø§Ù… MAWARAN</h3>
        <p style="font-size: 13px; color: #666;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="password" id="accessCode" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="text-align: center;">
        <button onclick="verifyAccessCode()">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²</button>
        <p id="errorCode" style="color: red; font-size: 12px; margin-top: 10px; display: none;">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!</p>
    </div>
</div>

<div id="appModal" class="hidden">
    <div class="modal-content">
        <h3 id="modalTitle">Ø¨Û•ÛŒØ§Ù†ÛŒ Ø¨Ø§Ø´ - ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±</h3>
        <p id="modalBody">Ù‡Ù„ Ø§Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ - Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒ Ø¨Û† Ú•Û†Ú˜ÛÚ©ÛŒ Ù†ÙˆÛ</p>
        <button id="openAppBtn" onclick="triggerAppOpening()">OK</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div id="clientDetailsModal" class="fullscreen-modal" style="z-index: 9992;">
    <div class="modal-header">
        <h3 data-key="details_title">ØªÙØ§ØµÙŠÙ„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <button class="close-btn" onclick="closeModal('clientDetailsModal')">&times;</button>
    </div>
    <div class="details-box">
        <label data-key="trade_name_label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ *</label>
        <input id="edit_tradeName" disabled>
        
        <label data-key="owner_name_label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ *</label>
        <input id="edit_ownerName" disabled>
        
        <label data-key="address_label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
        <input id="edit_address" disabled>
        
        <label data-key="phone_label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
        <input id="edit_phone" inputmode="numeric" disabled>
        
        <label data-key="category_label">Ø§Ù„ÙØ¦Ø© *</label>
        <select id="edit_category" disabled>
            <option value="ÙƒØ±Ø§Ø¬" data-key="garage">ÙƒØ±Ø§Ø¬</option>
            <option value="Ø¬Ù…Ù„Ø©" data-key="wholesale">Ø¬Ù…Ù„Ø©</option>
            <option value="Ù…ÙØ±Ø¯" data-key="retail">Ù…ÙØ±Ø¯</option>
        </select>
        
        <label data-key="note_label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <textarea id="edit_note" disabled></textarea>
        
        <label data-key="rate_label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… *</label>
        <select id="edit_rate" disabled>
            <option value="1">â­</option><option value="2">â­â­</option><option value="3">â­â­â­</option><option value="4">â­â­â­â­</option><option value="5">â­â­â­â­â­</option>
        </select>
        
        <label data-key="visit_days_label">ÙŠÙˆÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø© *</label>
        <select id="edit_visitDays" disabled>
            <option value="Ø§Ù„Ø³Ø¨Øª" data-key="sat">Ø§Ù„Ø³Ø¨Øª</option>
            <option value="Ø§Ù„Ø£Ø­Ø¯" data-key="sun">Ø§Ù„Ø£Ø­Ø¯</option>
            <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†" data-key="mon">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
            <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" data-key="tue">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
            <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" data-key="wed">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
            <option value="Ø§Ù„Ø®Ù…ÙŠØ³" data-key="thu">Ø§Ù„Ø®Ù…ÙŠØ³</option>
            <option value="Ø§Ù„Ø¬Ù…Ø¹Ù‡" data-key="fri">Ø§Ù„Ø¬Ù…Ø¹Ù‡</option>            
        </select>

        <!-- âœ… Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ + ÙÙ„ØªØ± UFI Ø¬Ù†Ø¨Ø§Ù‹ Ø¥Ù„Ù‰ Ø¬Ù†Ø¨ ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
        <div class="two-col-group">
            <div class="col">
                <label data-key="has_oil_label">Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ØŸ *</label>
                <select id="edit_useOil" disabled>
                    <option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
                    <option value="Ù„Ø§" data-key="no">Ù„Ø§</option>
                </select>
            </div>
            <div class="col">
                <label data-key="has_filter_label">ÙÙ„ØªØ± UFIØŸ *</label>
                <select id="edit_useFilter" disabled>
                    <option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
                    <option value="Ù„Ø§" data-key="no">Ù„Ø§</option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="enableEditBtn" onclick="enableClientEdit()" style="background:#ffc107; color:#000; margin-top:0;" data-key="edit_data">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button id="saveEditBtn" class="hidden" onclick="saveClientEdit()" style="background:#28a745; margin-top:0;" data-key="save_edits">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="login">
        <h2 data-key="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <label data-key="rep_name_label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</label>
        <input id="repName">
        <label data-key="city_label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *</label>
        <input id="city">
        <button onclick="saveLogin()" data-key="login_btn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="formBox" class="hidden">
        <button id="workBtn" onclick="openWorkModal()" style="background:#6f42c1;margin-bottom:10px;" data-key="work_btn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
    
        <div class="nav-tabs">
            <button id="tabNew" class="active" onclick="switchForm('new')" data-key="tab_new">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
            <button id="tabRegular" onclick="switchForm('regular')" data-key="tab_regular">Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ</button>
        </div>

        <div id="timerDisplay" class="hidden">00:00:00</div>
        <div class="visit-controls">
            <button id="startVisitBtn" onclick="toggleVisit()" data-key="start_visit">Ø¨Ø¯Ø¡<br>Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
            <button id="cancelVisitBtn" class="hidden" onclick="cancelVisit()" data-key="cancel_visit">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© âœ–</button>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ -->
        <div id="newClientForm">

            <!-- âœ… Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ + ÙÙ„ØªØ± UFI Ø¬Ù†Ø¨Ø§Ù‹ Ø¥Ù„Ù‰ Ø¬Ù†Ø¨ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <div class="two-col-group">
                <div class="col">
                    <label data-key="has_oil_label">Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ØŸ *</label>
                    <select id="useOil">
                        <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                        <option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
                        <option value="Ù„Ø§" data-key="no">Ù„Ø§</option>
                    </select>
                </div>
                <div class="col">
                    <label data-key="has_filter_label">ÙÙ„ØªØ± UFIØŸ *</label>
                    <select id="useFilter">
                        <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                        <option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
                        <option value="Ù„Ø§" data-key="no">Ù„Ø§</option>
                    </select>
                </div>
            </div>

            <label data-key="trade_name_label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ *</label>
            <input id="tradeName">
            <label data-key="owner_name_label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ *</label>
            <input id="ownerName">
            <label data-key="address_label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
            <input id="address">
            <label data-key="phone_label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
            <input id="phone" inputmode="numeric">
            <label data-key="category_label">Ø§Ù„ÙØ¦Ø© *</label>
            <select id="category">
                <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                <option value="ÙƒØ±Ø§Ø¬" data-key="garage">ÙƒØ±Ø§Ø¬</option>
                <option value="Ø¬Ù…Ù„Ø©" data-key="wholesale">Ø¬Ù…Ù„Ø©</option>
                <option value="Ù…ÙØ±Ø¯" data-key="retail">Ù…ÙØ±Ø¯</option>
            </select>
            <label data-key="note_label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <textarea id="note"></textarea>
            <label data-key="rate_label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… *</label>
            <select id="rate">
                <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                <option value="1">â­</option><option value="2">â­â­</option><option value="3">â­â­â­</option><option value="4">â­â­â­â­</option><option value="5">â­â­â­â­â­</option>
            </select>
            <label data-key="visit_days_label">ÙŠÙˆÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø© *</label>
            <select id="visitDays">
                <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                <option value="Ø§Ù„Ø³Ø¨Øª" data-key="sat">Ø§Ù„Ø³Ø¨Øª</option>
                <option value="Ø§Ù„Ø£Ø­Ø¯" data-key="sun">Ø§Ù„Ø£Ø­Ø¯</option>
                <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†" data-key="mon">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
                <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" data-key="tue">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" data-key="wed">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                <option value="Ø§Ù„Ø®Ù…ÙŠØ³" data-key="thu">Ø§Ù„Ø®Ù…ÙŠØ³</option>
                <option value="Ø§Ù„Ø¬Ù…Ø¹Ù‡" data-key="fri">Ø§Ù„Ø¬Ù…Ø¹Ù‡</option>
            </select>
            <hr style="opacity: 0.2; margin: 20px 0;">
            <label data-key="other_oil_label">Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª Ù…Ø§Ø±ÙƒØ© Ø£Ø®Ø±Ù‰</label>
            <input id="oilType">
            <label data-key="oil_grade_label">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø²ÙŠØª</label>
            <input id="oilGrade">
            <label data-key="distance_label">Ø§Ù„Ù…Ø³Ø§ÙØ©</label>
            <select id="oilDistance">
                <option value="" data-key="choose">Ø§Ø®ØªØ±</option>
                <option>3K ÙƒÙ…</option><option>5K ÙƒÙ…</option><option>10K ÙƒÙ…</option><option>15K ÙƒÙ…</option>
            </select>
            <label data-key="liter_price_label">Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ±</label>
            <input id="oilPrice" inputmode="numeric">
            <label data-key="store_img_label">ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ¬Ø± *</label>
            <input type="file" id="imageInputNew" accept="image/*" capture="environment">
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ -->
        <div id="regularClientForm" class="hidden">
            <label data-key="client_name_label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
            <div class="client-selection-group">
                <select id="reg_daySelect" onchange="filterClientsByDay()">
                    <option value="Ø§Ù„Ø³Ø¨Øª" data-key="sat">Ø§Ù„Ø³Ø¨Øª</option>
                    <option value="Ø§Ù„Ø£Ø­Ø¯" data-key="sun">Ø§Ù„Ø£Ø­Ø¯</option>
                    <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†" data-key="mon">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
                    <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" data-key="tue">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                    <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" data-key="wed">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                    <option value="Ø§Ù„Ø®Ù…ÙŠØ³" data-key="thu">Ø§Ù„Ø®Ù…ÙŠØ³</option>
                    <option value="Ø§Ù„Ø¬Ù…Ø¹Ù‡" data-key="fri">Ø§Ù„Ø¬Ù…Ø¹Ù‡</option>
                </select>
                <select id="reg_clientName" onchange="toggleDetailsBtn()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„-Ú©Ú•ÛŒØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</option>
                </select>
                <button id="showDetailsBtn" class="hidden" onclick="showClientDetails()" data-key="details_btn">ØªÙØ§ØµÙŠÙ„</button>
            </div>
            
            <label data-key="has_order_label">Ù‡Ù„ ØªÙ… Ø¹Ù…Ù„ Ø·Ù„Ø¨ÙŠØ©ØŸ</label>
            <select id="reg_hasOrder" onchange="toggleOrderFields()">
                <option value="Ù„Ø§" data-key="no">Ù„Ø§</option><option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
            </select>
            <div id="orderAmountBox" class="hidden">
                <label data-key="order_amount_label">Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ÙŠØ© *</label>
                <input id="reg_orderAmount" type="number">
            </div>
            <div id="orderReasonBox">
                <label data-key="no_order_reason">Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ© *</label>
                <input id="reg_orderReason">
            </div>
            <label data-key="has_payment_label">Ù‡Ù„ ØªÙ… Ù‚Ø¨Ø¶ Ù…Ø¨Ù„ØºØŸ</label>
            <select id="reg_hasPayment" onchange="togglePaymentFields()">
                <option value="Ù„Ø§" data-key="no">Ù„Ø§</option><option value="Ù†Ø¹Ù…" data-key="yes">Ù†Ø¹Ù…</option>
            </select>
            <div id="payAmountBox" class="hidden">
                <label data-key="pay_amount_label">Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¨Ø¶ *</label>
                <input id="reg_payAmount" type="number">
            </div>
            <div id="payReasonBox">
                <label data-key="no_pay_reason">Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¨Ø¶ *</label>
                <input id="reg_payReason">
            </div>
            <label data-key="note_label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <textarea id="reg_note"></textarea>
            <label data-key="take_photo_label">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© *</label>
            <input type="file" id="imageInputReg" accept="image/*" capture="environment">
        </div>

        <button id="sendBtn" onclick="handleSend()" data-key="send_data_btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <div id="msg"></div>
    </div>

    <div class="lang-switcher">
        <select id="langSelect" onchange="changeLanguage(this.value)">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
            <option value="ku">Ú©ÙˆØ±Ø¯ÛŒ (SoranÃ®)</option>
        </select>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙˆØ§Ù… -->
<div id="workModal" class="fullscreen-modal">
    <div class="modal-header">
        <h3 data-key="daily_work_title">Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
        <button class="close-btn" onclick="closeModal('workModal')">&times;</button>
    </div>
    <div class="details-box">
        <h4 data-key="start_work">Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…</h4>
        <label data-key="current_km">Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ *</label>
        <input type="number" inputmode="numeric" id="startKM">
        <label data-key="meter_img">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ *</label>
        <input type="file" accept="image/*" capture="environment" id="startKMImg">
        <hr>
        <h4 data-key="end_work">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…</h4>
        <label data-key="final_km">Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ *</label>
        <input type="number" inputmode="numeric" id="endKM">
        <label data-key="meter_img">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ *</label>
        <input type="file" accept="image/*" capture="environment" id="endKMImg">
        <button id="saveWorkBtn" onclick="saveWorkData()" style="background:#28a745; position: relative; overflow: hidden;">
            <span class="btn-text" data-key="save_send">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</span>
            <div class="spinner"></div>
        </button>
        <div id="kmMsg"></div>
    </div>
</div>
    
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_HPx6ad1_Ra_Piqh_pctORi0xvPumQV_4ReevWKoOHKrZLQwjber8c8urGdmcEWfX/exec";

let currentMode = 'new';
let visitStartTime = localStorage.getItem('visitStartTime') ? parseInt(localStorage.getItem('visitStartTime')) : null;
let startCoords = localStorage.getItem('startCoords') ? JSON.parse(localStorage.getItem('startCoords')) : null;
let timerInterval;
let isSending = false;
let allClients = [];

const translations = {
    ar: {
        modal_title: "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±", modal_body: "Ù‡Ù„ Ø§Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯", modal_btn: "OK",
        login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", rep_name_label: "Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *", city_label: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *", login_btn: "Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…",
        tab_new: "Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯", tab_regular: "Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ", start_visit: "Ø¨Ø¯Ø¡<br>Ø§Ù„Ø²ÙŠØ§Ø±Ø©", active_visit: "Ø²ÙŠØ§Ø±Ø©<br>Ø¬Ø§Ø±ÙŠØ©", 
        cancel_visit: "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© âœ–",
        has_oil_label: "Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ØŸ *",
        has_filter_label: "ÙÙ„ØªØ± UFIØŸ *",
        choose: "Ø§Ø®ØªØ±", yes: "Ù†Ø¹Ù…", no: "Ù„Ø§",
        trade_name_label: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ *", owner_name_label: "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ *", address_label: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *", phone_label: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *",
        category_label: "Ø§Ù„ÙØ¦Ø© *", garage: "ÙƒØ±Ø§Ø¬", wholesale: "Ø¬Ù…Ù„Ø©", retail: "Ù…ÙØ±Ø¯", note_label: "Ù…Ù„Ø§Ø­Ø¸Ø©",
        rate_label: "Ø§Ù„ØªÙ‚ÙŠÙŠÙ… *", visit_days_label: "Ø§ÙŠØ§Ù… Ø§Ù„Ø²ÙŠØ§Ø±Ø©*", other_oil_label: "Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª Ù…Ø§Ø±ÙƒØ© Ø£Ø®Ø±Ù‰",
        oil_grade_label: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø²ÙŠØª", distance_label: "Ø§Ù„Ù…Ø³Ø§ÙØ©", liter_price_label: "Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ±", store_img_label: "ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ¬Ø± *",
        client_name_label: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *", has_order_label: "Ù‡Ù„ ØªÙ… Ø¹Ù…Ù„ Ø·Ù„Ø¨ÙŠØ©ØŸ", order_amount_label: "Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ÙŠØ© *",
        no_order_reason: "Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ© *", has_payment_label: "Ù‡Ù„ ØªÙ… Ù‚Ø¨Ø¶ Ù…Ø¨Ù„ØºØŸ", pay_amount_label: "Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¨Ø¶ *",
        no_pay_reason: "Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¨Ø¶ *", take_photo_label: "Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© *", send_data_btn: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        alert_fill: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", alert_geo: "ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©", alert_cancel: "Ø³ÙŠØªÙ… Ø­Ø°Ù ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
        alert_dist: "Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø¹ÙŠØ¯Ø© Ø¬Ø¯Ø§Ù‹", sending: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...", wait: "â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", success: "âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­", loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...",
        sat: "Ø§Ù„Ø³Ø¨Øª", sun: "Ø§Ù„Ø£Ø­Ø¯", mon: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", tue: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", wed: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", thu: "Ø§Ù„Ø®Ù…ÙŠØ³", fri: "Ø§Ù„Ø¬Ù…Ø¹Ù‡",
        work_btn: "Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…", details_btn: "ØªÙØ§ØµÙŠÙ„", details_title: "ØªÙØ§ØµÙŠÙ„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„", 
        edit_data: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", save_edits: "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª", daily_work_title: "Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ",
        start_work: "Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…", current_km: "Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ *", meter_img: "ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ *",
        end_work: "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…", final_km: "Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ *", save_send: "Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„"
    },
    ku: {
        modal_title: "Ø¨Û•ÛŒØ§Ù†ÛŒ Ø¨Ø§Ø´", modal_body: "Ø¦Ø§ÛŒØ§ Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒ Ø¨Û† Ú•Û†Ú˜ÛÚ©ÛŒ Ù†ÙˆÛØŸ", modal_btn: "OK",
        login_title: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•", rep_name_label: "Ù†Ø§ÙˆÛŒ Ù†ÙˆÛÙ†Û•Ø± *", city_label: "Ø´Ø§Ø± *", login_btn: "Ú†ÙˆÙˆÙ†Û• Ù†Ø§Ùˆ Ø³ÛŒØ³ØªÙ…",
        tab_new: "Ú©Ú•ÛŒØ§Ø±ÛŒ Ù†ÙˆÛ", tab_regular: "Ú©Ú•ÛŒØ§Ø±ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ", start_visit: "Ø¯Û•Ø³ØªÙ¾ÛÚ©ÛŒ<br>Ø³Û•Ø±Ø¯Ø§Ù†", active_visit: "Ø³Û•Ø±Ø¯Ø§Ù†<br>Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…Û•",
        cancel_visit: "Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø³Û•Ø±Ø¯Ø§Ù† âœ–",
        has_oil_label: "Ø±ÙˆÙ†Ù‰ Ú•ÛŒÙ…Ø§Ú©Ø³ØŸ *",
        has_filter_label: "ÙÙ„ØªÛ•Ø±ÛŒ UFIØŸ *",
        choose: "Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•", yes: "Ø¨Û•ÚµÛ", no: "Ù†Û•Ø®ÛØ±",
        trade_name_label: "Ù†Ø§ÙˆÛŒ Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ *", owner_name_label: "Ù†Ø§ÙˆÛŒ Ø®Ø§ÙˆÛ•Ù† *", address_label: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù† *", phone_label: "Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„ *",
        category_label: "Ù¾Û†Ù„ÛÙ† *", garage: "Ú¯Û•Ø±Ø§Ø¬", wholesale: "ÙƒÙˆ", retail: "ØªØ§Ú©", note_label: "ØªÛØ¨ÛŒÙ†ÛŒ",
        rate_label: "Ù‡Û•ÚµØ³Û•Ù†Ú¯Ø§Ù†Ø¯Ù† *", visit_days_label: "Ú•Û†Ú˜ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†*", other_oil_label: "Ø¬Û†Ø±ÙŠ Ø²Û•ÛŒØªÛŒ Ù…Ø§Ø±Ú©Û•ÛŒÛ•Ú©ÛŒ ØªØ±",
        oil_grade_label: "Ù¾Ù„Û•ÛŒ Ø±ÙˆÙ†", distance_label: "Ù…Û•ÙˆØ¯Ø§", liter_price_label: "Ù†Ø±Ø®ÛŒ Ù„ÛŒØªØ±", store_img_label: "ÙˆÛÙ†Û•ÛŒ ÙØ±Û†Ø´Ú¯Ø§ *",
        client_name_label: "Ù†Ø§ÙˆÛŒ Ú©Ú•ÛŒØ§Ø± *", has_order_label: "Ø¦Ø§ÛŒØ§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ØŸ", order_amount_label: "Ø¨Ú•ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ *",
        no_order_reason: "Ù‡Û†Ú©Ø§Ø±ÛŒ ØªÛ†Ù…Ø§Ø±Ù†Û•Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ *", has_payment_label: "Ø¦Ø§ÛŒØ§ Ù¾Ø§Ø±Û• ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§ØŸ", pay_amount_label: "Ø¨Ú•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ *",
        no_pay_reason: "Ù‡Û†Ú©Ø§Ø±ÛŒ ÙˆÛ•Ø±Ù†Û•Ú¯Ø±ØªÙ†ÛŒ Ù¾Ø§Ø±Û• *", take_photo_label: "ÙˆÛÙ†Û•Ú¯Ø±ØªÙ† *", send_data_btn: "Ù†Ø§Ø±Ø¯Ù†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†",
        alert_fill: "ØªÚ©Ø§ÛŒÛ• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•", alert_geo: "Ø¯Û•Ø¨ÛØª Ø´ÙˆÛÙ†ÛÙ†Û•Ú©Û•Øª Ú†Ø§Ù„Ø§Ú© Ø¨Ú©Û•ÛŒØª", alert_cancel: "Ú©Ø§ØªÛŒ Ø³Û•Ø±Ø¯Ø§Ù†Û•Ú©Û• Ø¯Û•Ø³Ú•ÛØªÛ•ÙˆÛ•ØŒ Ø¯ÚµÙ†ÛŒØ§ÛŒØªØŸ",
        alert_dist: "Ù…Û•ÙˆØ¯Ø§Ú©Û• Ø²Û†Ø± Ø¯ÙˆÙˆØ±Û•", sending: "Ø®Û•Ø±ÛŒÚ©ÛŒ Ù†Ø§Ø±Ø¯Ù†Û•...", wait: "â³ ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•ØŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ø¨Û•Ø±Ø²Ø¯Û•Ú©Ø±ÛÙ†Û•ÙˆÛ•...", success: "âœ… Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ", loading: "Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ø´ÙˆÛÙ†...",
        sat: "Ø´Û•Ù…Ù…Û•", sun: "ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•", mon: "Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•", tue: "Ø³ÛØ´Û•Ù…Ù…Û•", wed: "Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•", thu: "Ù¾ÛÙ†Ø¬Ø´Û•Ù…Ù…Û•", fri: "Ù‡Û•ÛŒÙ†ÛŒ",
        work_btn: "Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ú©Ø§Ø±", details_btn: "ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†", details_title: "ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ùˆ Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ Ú©Ú•ÛŒØ§Ø±", 
        edit_data: "Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†", save_edits: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†ÛŒ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†", daily_work_title: "Ø¯Û•ÙˆØ§Ù…ÛŒ Ú•Û†Ú˜Ø§Ù†Û•",
        start_work: "Ø¯Û•Ø³ØªÙ¾ÛÚ©ÛŒ Ø¯Û•ÙˆØ§Ù…", current_km: "Ú©ÛŒÙ„Û†Ù…Û•ØªØ±ÛŒ Ø¦ÛØ³ØªØ§ *", meter_img: "ÙˆÛÙ†Û•ÛŒ Ù¾ÛÙˆÛ•Ø± *",
        end_work: "Ú©Û†ØªØ§ÛŒÛŒ Ø¯Û•ÙˆØ§Ù…", final_km: "Ú©ÛŒÙ„Û†Ù…Û•ØªØ±ÛŒ Ú©Û†ØªØ§ÛŒÛŒ *", save_send: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù† Ùˆ Ù†Ø§Ø±Ø¯Ù†"
    }
};

function verifyAccessCode() {
    const input = document.getElementById('accessCode').value;
    const correctCode = "Mm19941994Mm";
    if(input === correctCode) {
        localStorage.setItem('isVerified', 'true');
        document.getElementById('securityModal').classList.add('hidden');
    } else {
        document.getElementById('errorCode').style.display = 'block';
    }
}

function checkDailyAppModal() {
    const today = new Date().toLocaleDateString();
    const lastOpen = localStorage.getItem('lastTraccarOpenDate');
    const lang = localStorage.getItem('appLang') || 'ar';
    if (lastOpen !== today) {
        const modal = document.getElementById('appModal');
        modal.classList.remove('hidden');
        document.getElementById('modalTitle').innerText = translations[lang].modal_title;
        document.getElementById('modalBody').innerText = translations[lang].modal_body;
        document.getElementById('openAppBtn').innerText = translations[lang].modal_btn;
    }
}

function triggerAppOpening() {
    const today = new Date().toLocaleDateString();
    const appPackage = "org.traccar.client";
    window.location.href = "intent://#Intent;scheme=org.traccar.client;package=" + appPackage + ";end";
    document.getElementById('appModal').classList.add('hidden');
    localStorage.setItem('lastTraccarOpenDate', today);
}

window.onload = () => {
    if(localStorage.getItem('isVerified') === 'true') {
        document.getElementById('securityModal').classList.add('hidden');
    }
    checkDailyAppModal();
    const savedLang = localStorage.getItem('appLang') || 'ar';
    document.getElementById('langSelect').value = savedLang;
    changeLanguage(savedLang);
    if(localStorage.repName) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('formBox').classList.remove('hidden');
        if(visitStartTime) resumeVisit();
        fetchClientsData();
        setCurrentDay();
    }
};

function changeLanguage(lang) {
    localStorage.setItem('appLang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = "rtl"; 
    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        if (translations[lang][key]) {
            if (el.id === 'startVisitBtn' && visitStartTime) {
                el.innerHTML = translations[lang]['active_visit'];
            } else {
                el.innerHTML = translations[lang][key];
            }
        }
    });
    const clientSelect = document.getElementById('reg_clientName');
    if (clientSelect && clientSelect.options[0] && clientSelect.options[0].value === "") {
        clientSelect.options[0].text = (lang === 'ku') ? "Ú©Ú•ÛŒØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•..." : "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„...";
    }
}

function saveLogin() {
    const lang = localStorage.getItem('appLang') || 'ar';
    const r = document.getElementById('repName').value;
    const c = document.getElementById('city').value;
    if(!r || !c) return alert(translations[lang].alert_fill);
    localStorage.repName = r; localStorage.city = c;
    location.reload();
}

function switchForm(mode) {
    currentMode = mode;
    document.getElementById('newClientForm').classList.toggle('hidden', mode !== 'new');
    document.getElementById('regularClientForm').classList.toggle('hidden', mode !== 'regular');
    document.getElementById('tabNew').classList.toggle('active', mode === 'new');
    document.getElementById('tabRegular').classList.toggle('active', mode === 'regular');
}

function setCurrentDay() {
    const days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    const today = days[new Date().getDay()];
    document.getElementById('reg_daySelect').value = (today === "Ø§Ù„Ø¬Ù…Ø¹Ø©") ? "Ø§Ù„Ø³Ø¨Øª" : today;
}

function fetchClientsData() {
    const repName = localStorage.repName;
    if (!repName) return;

    const selectElem = document.getElementById('reg_clientName');
    selectElem.innerHTML = '<option value="">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</option>';
    selectElem.disabled = true;

    const url = SCRIPT_URL + '?action=getClients&repName=' + encodeURIComponent(repName);

    fetch(url, { redirect: 'follow' })
        .then(function(res) { return res.text(); })
        .then(function(text) {
            selectElem.disabled = false;
            let data;
            try { data = JSON.parse(text); } catch(e) {
                selectElem.innerHTML = '<option value="">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>';
                showRetryBtn(); return;
            }
            if (data && data.status === 'success' && Array.isArray(data.data)) {
                allClients = data.data;
                filterClientsByDay();
            } else {
                selectElem.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙˆÙ†</option>';
                showRetryBtn();
            }
        })
        .catch(function(err) {
            selectElem.disabled = false;
            selectElem.innerHTML = '<option value="">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</option>';
            showRetryBtn();
        });
}

function showRetryBtn() {
    let retryBtn = document.getElementById('retryFetchBtn');
    if (!retryBtn) {
        retryBtn = document.createElement('button');
        retryBtn.id = 'retryFetchBtn';
        retryBtn.style.cssText = 'background:#dc3545;margin-top:6px;padding:6px;font-size:13px;';
        retryBtn.innerText = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
        retryBtn.onclick = function() { retryBtn.remove(); fetchClientsData(); };
        const group = document.querySelector('.client-selection-group');
        if (group) group.parentNode.insertBefore(retryBtn, group.nextSibling);
    }
}

function filterClientsByDay() {
    const selectedDay = document.getElementById('reg_daySelect').value;
    const selectElem  = document.getElementById('reg_clientName');
    const lang        = localStorage.getItem('appLang') || 'ar';

    selectElem.innerHTML = '<option value="">' + (lang === 'ku' ? 'Ú©Ú•ÛŒØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•' : 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„') + '</option>';

    if (!allClients || allClients.length === 0) { toggleDetailsBtn(); return; }

    const filtered = allClients.filter(function(c) {
        return c.visitDays && c.visitDays.toString().trim() === selectedDay.trim();
    });

    filtered.forEach(function(client) {
        const option = document.createElement('option');
        option.value = client.id || client.tradeName;
        option.text  = client.tradeName || '(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)';
        selectElem.appendChild(option);
    });

    toggleDetailsBtn();
}

function toggleDetailsBtn() {
    const val = document.getElementById('reg_clientName').value;
    document.getElementById('showDetailsBtn').classList.toggle('hidden', !val);
}

function showClientDetails() {
    const selectedValue = document.getElementById('reg_clientName').value;
    const client = allClients.find(function(c) {
        return String(c.id) === String(selectedValue) || c.tradeName === selectedValue;
    });
    if (!client) return;

    document.getElementById('edit_tradeName').value  = client.tradeName  || '';
    document.getElementById('edit_ownerName').value  = client.ownerName  || '';
    document.getElementById('edit_address').value    = client.address    || '';
    document.getElementById('edit_phone').value      = client.phone      || '';
    document.getElementById('edit_category').value   = client.category   || '';
    document.getElementById('edit_note').value       = client.note       || '';
    document.getElementById('edit_rate').value       = client.rate       || '';
    document.getElementById('edit_visitDays').value  = client.visitDays  || '';
    document.getElementById('edit_useOil').value     = client.useOil     || '';
    document.getElementById('edit_useFilter').value  = client.useFilter  || '';

    const fields = ['edit_tradeName','edit_ownerName','edit_address','edit_phone','edit_category','edit_note','edit_rate','edit_visitDays','edit_useOil','edit_useFilter'];
    fields.forEach(function(id) { document.getElementById(id).disabled = true; });
    
    document.getElementById('enableEditBtn').classList.remove('hidden');
    document.getElementById('saveEditBtn').classList.add('hidden');
    document.getElementById('clientDetailsModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function enableClientEdit() {
    const fields = ['edit_tradeName','edit_ownerName','edit_address','edit_phone','edit_category','edit_note','edit_rate','edit_visitDays','edit_useOil','edit_useFilter'];
    fields.forEach(function(id) { document.getElementById(id).disabled = false; });
    document.getElementById('enableEditBtn').classList.add('hidden');
    document.getElementById('saveEditBtn').classList.remove('hidden');
}

function saveClientEdit() {
    const clientId = document.getElementById('reg_clientName').value;
    const btn = document.getElementById('saveEditBtn');
    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

    const updatedData = {
        action: 'updateClient',
        id: clientId,
        tradeName:  document.getElementById('edit_tradeName').value,
        ownerName:  document.getElementById('edit_ownerName').value,
        address:    document.getElementById('edit_address').value,
        phone:      document.getElementById('edit_phone').value,
        category:   document.getElementById('edit_category').value,
        note:       document.getElementById('edit_note').value,
        rate:       document.getElementById('edit_rate').value,
        visitDays:  document.getElementById('edit_visitDays').value,
        useOil:     document.getElementById('edit_useOil').value,
        useFilter:  document.getElementById('edit_useFilter').value,
    };

    fetch(SCRIPT_URL, { method: "POST", redirect: 'follow', body: JSON.stringify(updatedData) })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            btn.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ“";
            setTimeout(function() {
                closeModal('clientDetailsModal');
                fetchClientsData();
            }, 1500);
        })
        .catch(function(err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
            btn.disabled = false;
            btn.innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        });
}

function toggleVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    const btn = document.getElementById('startVisitBtn');
    if(!visitStartTime) {
        btn.disabled = true;
        btn.innerHTML = translations[lang].loading;
        navigator.geolocation.getCurrentPosition(function(pos) {
            visitStartTime = Date.now();
            startCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            localStorage.setItem('visitStartTime', visitStartTime);
            localStorage.setItem('startCoords', JSON.stringify(startCoords));
            resumeVisit();
        }, function() {
            alert(translations[lang].alert_geo);
            btn.disabled = false;
            btn.innerHTML = translations[lang].start_visit;
        }, { enableHighAccuracy: true });
    }
}

function resumeVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    document.getElementById('timerDisplay').classList.remove('hidden');
    document.getElementById('cancelVisitBtn').classList.remove('hidden');
    const btn = document.getElementById('startVisitBtn');
    btn.classList.add('active');
    btn.innerHTML = translations[lang].active_visit;
    btn.disabled = true;
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(function() {
        const diff = Date.now() - visitStartTime;
        const h = Math.floor(diff/3600000).toString().padStart(2,'0');
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = h+':'+m+':'+s;
    }, 1000);
}

function cancelVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    if(confirm(translations[lang].alert_cancel)) {
        clearInterval(timerInterval);
        localStorage.removeItem('visitStartTime');
        localStorage.removeItem('startCoords');
        visitStartTime = null; startCoords = null;
        const btn = document.getElementById('startVisitBtn');
        btn.classList.remove('active');
        btn.disabled = false;
        btn.innerHTML = translations[lang].start_visit;
        document.getElementById('timerDisplay').classList.add('hidden');
        document.getElementById('cancelVisitBtn').classList.add('hidden');
    }
}

function toggleOrderFields() {
    const val = document.getElementById('reg_hasOrder').value;
    document.getElementById('orderAmountBox').classList.toggle('hidden', val === 'Ù„Ø§');
    document.getElementById('orderReasonBox').classList.toggle('hidden', val === 'Ù†Ø¹Ù…');
}

function togglePaymentFields() {
    const val = document.getElementById('reg_hasPayment').value;
    document.getElementById('payAmountBox').classList.toggle('hidden', val === 'Ù„Ø§');
    document.getElementById('payReasonBox').classList.toggle('hidden', val === 'Ù†Ø¹Ù…');
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1*Math.PI/180, Ï†2 = lat2*Math.PI/180;
    const Î”Ï† = (lat2-lat1)*Math.PI/180, Î”Î» = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2)+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function getTodayKey() {
    const d = new Date();
    return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
}

function checkOldKM() {
    const today = getTodayKey();
    const savedDate = localStorage.getItem("kmDate");
    if (savedDate && savedDate !== today) {
        localStorage.removeItem("kmStart");
        localStorage.removeItem("kmDate");
    }
}
checkOldKM();

function openWorkModal() {
    document.getElementById("workModal").style.display = "block";
    const saved = localStorage.getItem("kmStart");
    if (saved) {
        const data = JSON.parse(saved);
        document.getElementById("startKM").value = data.km;
    }
}

async function saveWorkData() {
    const btn = document.getElementById('saveWorkBtn');
    const btnText = btn.querySelector('.btn-text');
    if(btn.classList.contains('sending')) return;
    btn.classList.add('sending');
    btn.disabled = true;
    btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    const repName = localStorage.repName;
    const startKM = document.getElementById("startKM").value;
    const endKM = document.getElementById("endKM").value;
    const startImgFile = document.getElementById("startKMImg").files[0];
    const endImgFile = document.getElementById("endKMImg").files[0];
    const kmMsg = document.getElementById("kmMsg");

    if (startKM && startImgFile && !endKM) {
        compressImage(startImgFile, function(base64) {
            localStorage.setItem("kmStart", JSON.stringify({ km: startKM, image: base64, startTime: new Date().toISOString() }));
            localStorage.setItem("kmDate", getTodayKey());
            kmMsg.innerHTML = "âœ… ØªÙ… Ø­ÙØ¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù… - Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø§";
            btn.classList.remove('sending');
            btn.disabled = false;
            btnText.innerText = "Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„";
        });
        return;
    }

    if (!localStorage.getItem("kmStart")) { alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù… Ø£ÙˆÙ„Ø§Ù‹"); btn.classList.remove('sending'); btn.disabled=false; btnText.innerText="Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„"; return; }
    if (!endKM || !endImgFile) { alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡"); btn.classList.remove('sending'); btn.disabled=false; btnText.innerText="Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„"; return; }

    const startData = JSON.parse(localStorage.getItem("kmStart"));
    const distance = endKM - startData.km;

    compressImage(endImgFile, function(endBase64) {
        fetch(SCRIPT_URL, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action:"saveKM", repName, startKM:startData.km, startTime:startData.startTime, startImage:startData.image, endKM, endTime:new Date().toISOString(), endImage:endBase64, distance })
        }).then(function() {
            localStorage.removeItem("kmStart");
            localStorage.removeItem("kmDate");
            kmMsg.innerHTML = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø¨Ù†Ø¬Ø§Ø­";
            setTimeout(function(){ location.reload(); }, 1500);
        });
    });
}

function compressImage(file, callback) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function(event) {
        const img = new Image();
        img.src = event.target.result;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 800;
            let width = img.width, height = img.height;
            if (width > MAX_WIDTH) { height *= MAX_WIDTH/width; width = MAX_WIDTH; }
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.7));
        };
    };
}

async function handleSend() {
    if(isSending) return;
    const lang = localStorage.getItem('appLang') || 'ar';
    if(!visitStartTime) return alert(translations[lang].start_visit.replace('<br>',' '));

    if (currentMode === 'new') {
        const reqNew = ['useOil','useFilter','tradeName','ownerName','address','phone','category','rate','visitDays'];
        for (let id of reqNew) {
            if (!document.getElementById(id).value.trim()) return alert(translations[lang].alert_fill);
        }
        if (document.getElementById('imageInputNew').files.length === 0) return alert(translations[lang].alert_fill + " (Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©)");
    } else {
        if (!document.getElementById('reg_clientName').value.trim()) return alert(translations[lang].alert_fill);
        const hasOrder = document.getElementById('reg_hasOrder').value;
        if (hasOrder === 'Ù†Ø¹Ù…' && !document.getElementById('reg_orderAmount').value.trim()) return alert(translations[lang].alert_fill);
        if (hasOrder === 'Ù„Ø§' && !document.getElementById('reg_orderReason').value.trim()) return alert(translations[lang].alert_fill);
        const hasPayment = document.getElementById('reg_hasPayment').value;
        if (hasPayment === 'Ù†Ø¹Ù…' && !document.getElementById('reg_payAmount').value.trim()) return alert(translations[lang].alert_fill);
        if (hasPayment === 'Ù„Ø§' && !document.getElementById('reg_payReason').value.trim()) return alert(translations[lang].alert_fill);
        if (document.getElementById('imageInputReg').files.length === 0) return alert(translations[lang].alert_fill + " (Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©)");
    }

    const btn = document.getElementById('sendBtn');
    const msg = document.getElementById('msg');
    isSending = true; btn.disabled = true; btn.innerText = translations[lang].loading;

    navigator.geolocation.getCurrentPosition(async function(pos) {
        const dist = getDistance(startCoords.lat, startCoords.lng, pos.coords.latitude, pos.coords.longitude);
        if(dist > 2000) {
            alert(translations[lang].alert_dist + ' (' + Math.round(dist) + 'm).');
            isSending = false; btn.disabled = false; btn.innerText = translations[lang].send_data_btn;
            return;
        }

        btn.innerText = translations[lang].sending;
        msg.innerText = translations[lang].wait;
        const durationMin = Math.floor((Date.now()-visitStartTime)/60000) + " min";

        let data = { sheetName: currentMode==='new'?'data':'Clients', repName: localStorage.repName, city: localStorage.city, duration: durationMin, lat: pos.coords.latitude, lng: pos.coords.longitude };

        const fileInput = currentMode==='new' ? document.getElementById('imageInputNew') : document.getElementById('imageInputReg');
        const file = fileInput.files[0];

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                let width = img.width, height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH/width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

                if(currentMode === 'new') {
                    data.tradeName    = document.getElementById('tradeName').value;
                    data.ownerName    = document.getElementById('ownerName').value;
                    data.useOil       = document.getElementById('useOil').value;
                    data.useFilter    = document.getElementById('useFilter').value;
                    data.address      = document.getElementById('address').value;
                    data.phone        = document.getElementById('phone').value;
                    data.category     = document.getElementById('category').value;
                    data.note         = document.getElementById('note').value;
                    data.rate         = document.getElementById('rate').value;
                    data.visitDays    = document.getElementById('visitDays').value;
                    data.oilType      = document.getElementById('oilType').value;
                    data.oilGrade     = document.getElementById('oilGrade').value;
                    data.oilDistance  = document.getElementById('oilDistance').value;
                    data.oilPrice     = document.getElementById('oilPrice').value;
                } else {
                    const select = document.getElementById('reg_clientName');
                    data.clientName   = select.options[select.selectedIndex].text;
                    data.hasOrder     = document.getElementById('reg_hasOrder').value;
                    data.orderAmount  = document.getElementById('reg_orderAmount').value;
                    data.orderReason  = document.getElementById('reg_orderReason').value;
                    data.hasPayment   = document.getElementById('reg_hasPayment').value;
                    data.payAmount    = document.getElementById('reg_payAmount').value;
                    data.payReason    = document.getElementById('reg_payReason').value;
                    data.note         = document.getElementById('reg_note').value;
                }
                data.image = compressedBase64;

                fetch(SCRIPT_URL, { method:"POST", mode:"no-cors", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) })
                    .then(function() {
                        msg.innerText = translations[lang].success;
                        localStorage.removeItem('visitStartTime');
                        localStorage.removeItem('startCoords');
                        setTimeout(function(){ location.reload(); }, 2000);
                    })
                    .catch(function() {
                        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                        isSending = false; btn.disabled = false;
                    });
            };
        };
    }, function() {
        alert(translations[lang].alert_geo);
        isSending = false; btn.disabled = false;
    }, { enableHighAccuracy: true });
}
</script>
</body>
</html>
