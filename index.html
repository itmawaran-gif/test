<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>

<style>
body { font-family:tahoma; background:#f2f4f7; margin:0; }
.container { max-width:420px; margin:auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 10px #0002; }
h2 { text-align:center; }
label { display:block; margin-top:10px; font-weight:bold; }
input, select, textarea, button { width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
input.error, select.error, textarea.error { border-color:red; background:#ffecec; }
button { background:#0a7cff; color:#fff; border:0; margin-top:15px; cursor:pointer; }
button:disabled { background:#999; cursor:not-allowed; }
#msg { text-align:center; margin-top:10px; font-weight:bold; }
.hidden { display:none; }

/* ===== top info ===== */
#topInfo { background:#eef; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
#topInfo span { font-weight:bold; }
#editBtn { width:auto; padding:6px 10px; font-size:14px; background:#666; cursor:pointer; }
#cityEdit { width:auto; padding:6px 10px; font-size:14px; }
</style>
</head>

<body>
<div class="container">

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="login">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

  <label> Ù†ÙˆÛÙ†Û•Ø± - Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</label>
  <input id="repName">

  <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø´Ø§Ø±*</label>
  <input id="city">

  <button onclick="saveLogin()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Ø§Ù„ÙÙˆØ±Ù… -->
<div id="formBox" class="hidden">

  <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ + Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
  <div id="topInfo">
    <span>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</span> <span id="repShow"></span> |
    <span>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span> <span id="cityShow"></span>

    <input id="cityEdit" class="hidden">
    <button id="editBtn" onclick="toggleEdit()">ØªØ¹Ø¯ÙŠÙ„</button>
  </div>

  <h2>MAWARAN CO</h2>

  <label>Ù‡Ù„ ÙŠÙ…ØªÙ„Ùƒ Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ - Ø¦Ø§ÛŒØ§ Ú•Û†Ù†ÛŒ Ú•ÛŒÙ…Ø§Ú©Ø³ Ù‡Û•ÛŒÛ•ØªÛŒ *</label>
  <select id="useOil">
    <option value="">Ø§Ø®ØªØ±</option>
    <option>Ù†Ø¹Ù… - Ø¨Û•ÚµÛ</option>
    <option>Ù„Ø§ - Ù†Û•Ø®ÛØ±</option>
  </select>

  <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ - Ù†Ø§ÙˆÛŒ Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ *</label>
  <input id="tradeName">

  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ - Ù†Ø§ÙˆÛŒ Ø®Ø§ÙˆÛ•Ù†Û•Ú©Û•ÛŒ *</label>
  <input id="ownerName">

  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†Û•Ú©Û• *</label>
  <input id="address">

  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ - Ú˜Ù…Ø§Ø±Û•ÛŒ ØªÛ•Ù„Û•ÙÛ†Ù† *</label>
  <input id="phone" inputmode="numeric">

  <label>Ø§Ù„ÙØ¦Ø© - Ø¬Û†Ø± *</label>
  <select id="category">
    <option value="">Ø§Ø®ØªØ±</option>
    <option>ÙƒØ±Ø§Ø¬</option>
    <option>Ø¬Ù…Ù„Ø©</option>
    <option>Ù…ÙØ±Ø¯</option>
  </select>

  <label>Ù…Ù„Ø§Ø­Ø¸Ø© - ØªÛØ¨ÛŒÙ†ÛŒ</label>
  <textarea id="note"></textarea>

  <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… - Ù‡Û•ÚµØ³Û•Ù†Ú¯Ø§Ù†Ø¯Ù† *</label>
  <select id="rate">
    <option value="">Ø§Ø®ØªØ±</option>
    <option value="1">â­</option>
    <option value="2">â­â­</option>
    <option value="3">â­â­â­</option>
    <option value="4">â­â­â­â­</option>
    <option value="5">â­â­â­â­â­</option>
  </select>

  <label>ÙƒÙ„ ÙƒÙ… ÙŠÙˆÙ… Ø²ÙŠØ§Ø±Ø© - Ú†Û•Ù†Ø¯ Ú•Û†Ú˜ Ø¯ÙˆØ§ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†Û•Ú©Û•ØŸ *</label>
  <input id="visitDays" inputmode="numeric">

  <!-- Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© -->
  <label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª Ù…Ù† Ù…Ø§Ø±ÙƒØ© Ø§Ø®Ø±Ù‡- Ø¬Û†Ø±ÛŒ Ø¦Û•Ùˆ Ú•Û†Ù†Û•ÛŒ Ú©Û• Ø¨Û•Ú©Ø§Ø±ÛŒ Ø¯Û•Ù‡ÛÙ†ÛØª</label>
  <input id="oilType">

  <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø²ÙŠØª - Ù¾Ù„Û•ÛŒ Ú•Û†Ù†</label>
  <input id="oilGrade">

  <label>ÙƒÙ… Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙŠ ÙŠÙ‚Ø·Ø¹Ù‡Ø§ - ØªØ§ Ú†Û•Ù†Ø¯ Ø¯Û•Ú•ÙˆØ§ØªØŸ</label>
  <select id="oilDistance">
    <option value="">Ø§Ø®ØªØ±</option>
    <option>3 ÙƒÙ…</option>
    <option>5 ÙƒÙ…</option>
    <option>10 ÙƒÙ…</option>
    <option>15 ÙƒÙ…</option>
  </select>

  <label>Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ± - Ù†Ø±Ø®ÛŒ Ù‡Û•Ø± Ù„ÛŒØªØ±ÛÚ©</label>
  <input id="oilPrice" inputmode="numeric">

  <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
  <label>ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ¬Ø± *</label>
  <input type="file" id="imageInput" accept="image/*" capture="environment">

  <!-- ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù‡Ù†Ø§ -->
  <button id="sendBtn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
  <div id="msg"></div>
</div>

</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbx08juomOJk3mDiL6OS5Ro2lxbdoyVoUGqmyS0CZobXIK4vmXPfbLeTXhRp_QEhYlCd/exec";
let uploadedImageData = "";
let isSending = false; // ğŸ”¹ Ø¬Ø¯ÙŠØ¯

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if(localStorage.repName){
  login.classList.add("hidden");
  formBox.classList.remove("hidden");
  repShow.textContent = localStorage.repName;
  cityShow.textContent = localStorage.city;
  cityEdit.value = localStorage.city;
}

function saveLogin(){
  if(!repName.value || !city.value) return;
  localStorage.repName = repName.value;
  localStorage.city = city.value;
  location.reload();
}

let editMode=false;
function toggleEdit(){
  editMode = !editMode;
  cityShow.classList.toggle("hidden", editMode);
  cityEdit.classList.toggle("hidden", !editMode);
  editBtn.textContent = editMode ? "Ø­ÙØ¸" : "ØªØ¹Ø¯ÙŠÙ„";

  if(!editMode){
    localStorage.city = cityEdit.value;
    cityShow.textContent = cityEdit.value;
  }
}

// ===== Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ =====
function resizeImage(file, maxWidth, maxHeight, callback){
  const reader = new FileReader();
  reader.onload = function(e){
    const img = new Image();
    img.onload = function(){
      let width = img.width;
      let height = img.height;

      if(width > maxWidth){
        height = height * (maxWidth / width);
        width = maxWidth;
      }
      if(height > maxHeight){
        width = width * (maxHeight / height);
        height = maxHeight;
      }

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      canvas.getContext("2d").drawImage(img, 0, 0, width, height);
      callback(canvas.toDataURL("image/jpeg", 0.7));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

imageInput.addEventListener("change", function(){
  const file = this.files[0];
  if(!file) return;
  resizeImage(file, 800, 800, function(resizedData){
    uploadedImageData = resizedData;
  });
});

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
function send(){
  if(isSending) return; // ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±

  const btn = document.getElementById("sendBtn");
  const required = [useOil, tradeName, ownerName, address, phone, category, rate, visitDays];
  let ok = true;

  required.forEach(f => {
    f.classList.remove("error");
    if(!f.value){ 
      f.classList.add("error"); 
      ok=false; 
    }
  });

  if(!uploadedImageData){
    imageInput.classList.add("error");
    ok = false;
  } else {
    imageInput.classList.remove("error");
  }

  if(!ok){
    msg.textContent = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©";
    return;
  }

  // ğŸ”’ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
  isSending = true;
  btn.disabled = true;
  btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  msg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  navigator.geolocation.getCurrentPosition(pos=>{
    const data = {
      repName: localStorage.repName,
      city: localStorage.city,
      tradeName: tradeName.value,
      ownerName: ownerName.value,
      useOil: useOil.value,
      address: address.value,
      phone: phone.value,
      category: category.value,
      note: note.value,
      rate: rate.value,
      visitDays: visitDays.value,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      oilType: oilType.value,
      oilGrade: oilGrade.value,
      oilDistance: oilDistance.value,
      oilPrice: oilPrice.value,
      image: uploadedImageData
    };

    fetch(URL,{
      method:"POST",
      body:JSON.stringify(data)
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.status==="success"){
        msg.textContent="âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­";
        document.querySelectorAll("#formBox input,#formBox textarea,#formBox select")
          .forEach(e=>{
            if(!["cityEdit","imageInput"].includes(e.id)) e.value="";
          });
        uploadedImageData = "";
      } else {
        msg.textContent="âŒ "+res.message;
      }
    })
    .finally(()=>{
      isSending = false;
      btn.disabled = false;
      btn.textContent = "Ø¥Ø±Ø³Ø§Ù„";
    });

  }, ()=>{
    msg.textContent="âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
    isSending = false;
    btn.disabled = false;
    btn.textContent = "Ø¥Ø±Ø³Ø§Ù„";
  });
}
</script>
</body>
</html>
