<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWARAN Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; background: #f0f9ff; margin: 0; transition: all 0.3s; }
        
        #splashScreen {
            position: fixed; inset: 0; background: #e0f2fe; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #loginPage, #dashboard { display: none; }
        
        .custom-card { 
            background: linear-gradient(135deg, #b9f3f7, #ffffff); 
            border: 2px solid #ffffff; 
            border-radius: 2rem; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .gauge-svg { width: 100%; height: auto; }
        .needle {
            transform-origin: 50px 50px;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(0deg); 
        }

        .slider-track {
            height: 10px; background: #e2e8f0; border-radius: 999px; position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); margin-top: 4px;
        }
        .slider-fill {
            height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 999px;
            position: absolute; left: 0; top: 0;
        }
        .slider-thumb {
            position: absolute; right: -8px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; background: #ffffff; border: 2px solid #cbd5e1;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .slider-label {
            position: absolute; top: -22px; right: -12px; background: white;
            padding: 1px 6px; border-radius: 8px; font-size: 9px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;
        }

        .input-soft { background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 9999px; padding: 0.8rem; text-align: center; width: 100%; outline: none; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body class="p-4">

<div id="splashScreen">
    <div class="custom-card p-10 mb-4">
        <h1 class="text-3xl font-bold text-sky-900 tracking-widest">MAWARAN</h1>
    </div>
    <div class="text-sky-900 font-bold animate-pulse" data-i18n="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</div>
</div>

<div class="max-w-md mx-auto space-y-4">
    
    <div id="loginPage" class="mt-10 space-y-6">
        <div class="custom-card p-4 text-center text-3xl font-bold text-sky-900 tracking-tighter">MAWARAN CO .</div>
        <div class="px-6 space-y-4 text-center">
            <p class="font-bold text-sky-900 text-xl" data-i18n="agent">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</p>
            <input type="text" id="user" class="input-soft shadow-inner">
            <p class="font-bold text-sky-900 text-xl" data-i18n="password">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>
            <input type="password" id="pass" class="input-soft shadow-inner">
            <button onclick="login()" id="loginBtn" class="w-full bg-sky-600 text-white py-4 rounded-full font-bold shadow-lg mt-4" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="dashboard" class="space-y-4">
        <div class="custom-card py-4 text-center text-3xl font-bold text-sky-900 tracking-tighter">MAWARAN CO .</div>

        <div class="grid grid-cols-2 gap-4">
            <div class="custom-card p-4 flex flex-col items-center justify-center">
                <svg viewBox="0 0 100 55" class="gauge-svg">
                    <defs>
                        <linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ef4444" />
                            <stop offset="50%" style="stop-color:#facc15" />
                            <stop offset="100%" style="stop-color:#22c55e" />
                        </linearGradient>
                    </defs>
                    <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e2e8f0" stroke-width="6" stroke-linecap="round"/>
                    <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="url(#gaugeGrad)" stroke-width="6" stroke-linecap="round"/>
                    <line id="needle" x1="50" y1="50" x2="15" y2="50" stroke="#38bdf8" stroke-width="3" stroke-linecap="round" class="needle"/>
                    <circle cx="50" cy="50" r="3" fill="#ffffff" stroke="#38bdf8" stroke-width="1.5"/>
                </svg>
                <div class="text-2xl font-bold text-sky-900 mt-2"><span id="perfVal">0</span> %</div>
            </div>

            <div class="custom-card p-4 space-y-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sky-900 text-sm" data-i18n="salary">Ø§Ù„Ø±Ø§ØªØ¨</span>
                    <span class="bg-sky-200/50 px-2 py-0.5 rounded-full text-[10px] font-bold shadow-inner" id="salary">0 IQD</span>
                </div>
                
                <div class="flex flex-col">
                    <span class="font-bold text-[11px] text-sky-900" data-i18n="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                    <span class="opacity-50 text-[9px] font-bold leading-none" id="sGoalMax">Goal: 10000$</span>
                    <div class="slider-track">
                        <div id="salesBar" class="slider-fill" style="width: 0%">
                            <div class="slider-label" id="salesVal">0$</div>
                            <div class="slider-thumb"></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col pt-1">
                    <span class="font-bold text-[11px] text-sky-900" data-i18n="collection">ØªØ­ØµÙŠÙ„</span>
                    <span class="opacity-50 text-[9px] font-bold leading-none" id="cGoalMax">Goal: 10000$</span>
                    <div class="slider-track">
                        <div id="collBar" class="slider-fill" style="width: 0%">
                            <div class="slider-label" id="collVal">0$</div>
                            <div class="slider-thumb"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="custom-card p-4 flex items-center">
            <div class="text-md font-bold text-sky-900 w-24 leading-tight" data-i18n="monthGoal">Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±</div>
            <div class="flex-1 px-4">
                <div class="slider-track">
                    <div id="mGoalBar" class="slider-fill" style="width: 0%">
                        <div class="slider-label" id="mGoalVal">0$</div>
                        <div class="slider-thumb"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative custom-card">
            <select id="custSelect" onchange="handleSelectChange(this)" class="w-full p-4 bg-transparent text-2xl font-bold text-sky-900 outline-none cursor-pointer text-center">
                <option value="" data-i18n="selectCust">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</option>
            </select>
            <div class="absolute left-10 top-1/2 -translate-y-1/2 pointer-events-none text-sky-900">â–¼</div>
        </div>

        <div class="custom-card p-5">
            <h3 class="text-center text-2xl font-bold border-b-2 border-sky-100 pb-2 mb-4 text-sky-900 tracking-widest" data-i18n="todayColl">ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div id="todayList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            <div class="flex justify-between items-center mt-6 pt-2 border-t-2 border-sky-100">
                <div class="bg-white/50 px-8 py-1 rounded-full border border-sky-100 font-bold text-2xl text-sky-900" id="dayTotal">$ 0</div>
                <div class="bg-white/50 px-6 py-1 rounded-full border border-sky-100 font-bold text-xl text-sky-900" data-i18n="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
            </div>
        </div>

        <button onclick="toggleLanguage()" class="w-full py-3 bg-white/50 rounded-full font-bold text-sky-900 shadow-sm border border-white flex justify-center items-center gap-2">
            ğŸŒ <span id="langBtnText">Ú©ÙˆØ±Ø¯ÛŒ</span>
        </button>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-sky-900/20 backdrop-blur-sm hidden flex items-center justify-center p-6 z-50">
    <div class="custom-card w-full max-w-sm p-6 space-y-4">
        <h2 id="modalTitle" class="text-center text-2xl font-bold text-sky-900 border-b pb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <div class="space-y-3">
            <p class="text-center font-bold text-sky-800" data-i18n="amtD">Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙˆÙ„Ø§Ø± $</p>
            <input type="number" id="amtD" class="input-soft text-lg font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="amtIQ">Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙŠÙ†Ø§Ø±</p>
            <input type="number" id="amtIQ" oninput="calcExchange()" class="input-soft text-lg font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="rate">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</p>
            <input type="number" id="rate" value="1500" class="input-soft text-sm font-bold">
            <p class="text-center font-bold text-sky-800" data-i18n="note">Ù…Ù„Ø§Ø­Ø¸Ø©</p>
            <input type="text" id="note" class="input-soft">
            <button onclick="sendData()" id="sendBtn" class="w-full py-4 bg-sky-400/80 text-sky-900 text-3xl font-bold rounded-full shadow-lg mt-4" data-i18n="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
            <button onclick="closeModal()" class="w-full text-xs text-gray-400 mt-2" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzoGS4m-KUQhHKxpjvZEO78uQaRtXPvnwf0XXR0teHCA3wLDOgSdSiM3OS1cUKpLZ4t/exec";
let agent = null;

// Ù†ØµÙˆØµ Ø§Ù„ØªØ±Ø¬Ù…Ø©
const i18n = {
    ar: {
        loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...",
        agent: "Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨",
        password: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ",
        loginBtn: "Ø¯Ø®ÙˆÙ„",
        salary: "Ø§Ù„Ø±Ø§ØªØ¨",
        sales: "Ù…Ø¨ÙŠØ¹Ø§Øª",
        collection: "ØªØ­ØµÙŠÙ„",
        monthGoal: "Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±",
        selectCust: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨",
        todayColl: "ØªØ­ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…",
        total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
        amtD: "Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙˆÙ„Ø§Ø± $",
        amtIQ: "Ø§Ù„Ù…Ø¨Ù„Øº Ø¯ÙŠÙ†Ø§Ø±",
        rate: "Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù",
        note: "Ù…Ù„Ø§Ø­Ø¸Ø©",
        sendBtn: "Ø§Ø±Ø³Ø§Ù„",
        cancel: "Ø¥Ù„ØºØ§Ø¡",
        langName: "Ú©ÙˆØ±Ø¯ÛŒ"
    },
    ku: {
        loading: "Ù†ÙˆÛ Ø¯Û•Ú©Ø±ÛØªÛ•ÙˆÛ•...",
        agent: "Ù†ÙˆÛÙ†Û•Ø±",
        password: "ØªÛÙ¾Û•Ú•Û•ÙˆØ´Û•",
        loginBtn: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•",
        salary: "Ù…ÙˆÙˆÚ†Û•",
        sales: "ÙØ±Û†Ø´ØªÙ†",
        collection: "Ú©Û†Ú©Ø±Ø¯Ù†Û•ÙˆÛ•",
        monthGoal: "Ø¦Ø§Ù…Ø§Ù†Ø¬ÛŒ Ù…Ø§Ù†Ú¯",
        selectCust: "Ú©Ú•ÛŒØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•",
        todayColl: "Ú©Û†Ú©Ø±Ø§ÙˆÛ•ÛŒ Ø¦Û•Ù…Ú•Û†",
        total: "Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ",
        amtD: "Ø¨Ú• Ø¨Û• Ø¯Û†Ù„Ø§Ø± $",
        amtIQ: "Ø¨Ú• Ø¨Û• Ø¯ÛŒÙ†Ø§Ø±",
        rate: "Ù†Ø±Ø®ÛŒ Ø¦Ø§ÚµÙˆÚ¯Û†Ú•",
        note: "ØªÛØ¨ÛŒÙ†ÛŒ",
        sendBtn: "Ù†Ø§Ø±Ø¯Ù†",
        cancel: "Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•",
        langName: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
    }
};

let currentLang = localStorage.getItem('mawar_lang') || 'ar';

function applyLanguage() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir = (currentLang === 'ar' || currentLang === 'ku') ? 'rtl' : 'ltr';
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.innerText = i18n[currentLang][key];
    });
    
    document.getElementById('langBtnText').innerText = i18n[currentLang].langName;
}

function toggleLanguage() {
    currentLang = currentLang === 'ar' ? 'ku' : 'ar';
    localStorage.setItem('mawar_lang', currentLang);
    applyLanguage();
}

window.onload = () => {
    applyLanguage(); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    const saved = localStorage.getItem('mawar_session');
    if(saved) {
        const d = JSON.parse(saved);
        performLogin(d.u, d.p, true);
    } else {
        setTimeout(() => {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }, 1000);
    }
};

// (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
async function performLogin(u, p, isAuto) {
    try {
        const r = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
        const res = await r.json();
        if(res.success) {
            agent = res.data;
            localStorage.setItem('mawar_session', JSON.stringify({u, p}));
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateUI();
            loadCustomers();
        } else {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }
    } catch(e) { document.getElementById('splashScreen').style.display = 'none'; }
}

function updateUI() {
    const needle = document.getElementById('needle');
    const perfDisplay = document.getElementById('perfVal');
    const targetPerf = Math.round(agent.perf * 100); 

    // Ø¶Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø±Ø¨ ÙˆØ§Ù„Ø±Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ± ØªÙ…Ø§Ù…Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    needle.style.transition = "none"; 
    needle.style.transform = "rotate(0deg)";
    perfDisplay.innerText = "0";

    // Ø·Ù„Ø¨ Ø¥Ø·Ø§Ø± Ø±Ø³Ù… Ù„Ø¶Ù…Ø§Ù† ØªÙ†ÙÙŠØ° Ø§Ù„ØªØµÙÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
    requestAnimationFrame(() => {
        setTimeout(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ø§Ù†Ø²ÙŠØ´Ù† Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ©
            needle.style.transition = "transform 1.5s cubic-bezier(0.4, 0, 0.2, 1)";
            
            // 1. Ø§Ù„Ø­Ø±ÙƒØ© Ø¥Ù„Ù‰ 100 (180 Ø¯Ø±Ø¬Ø©)
            needle.style.transform = "rotate(180deg)";
            
            // Ø¹Ø¯Ø§Ø¯ Ø±Ù‚Ù…ÙŠ ÙˆÙ‡Ù…ÙŠ ÙŠØµØ¹Ø¯ Ø¥Ù„Ù‰ 100
            let tempVal = 0;
            let upInterval = setInterval(() => {
                if(tempVal >= 100) {
                    clearInterval(upInterval);
                } else {
                    tempVal += 2;
                    perfDisplay.innerText = tempVal;
                }
            }, 10);

            // 2. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµØ¹ÙˆØ¯
            setTimeout(() => {
                const targetRotation = targetPerf * 1.8;
                needle.style.transform = `rotate(${targetRotation}deg)`;
                
                // Ø¹Ø¯Ø§Ø¯ Ø±Ù‚Ù…ÙŠ ÙŠÙ†Ø²Ù„ Ø£Ùˆ ÙŠØ³ØªÙ‚Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
                perfDisplay.innerText = targetPerf;
            }, 1500); 
        }, 100);
    });

    // ØªØ­Ø¯ÙŠØ« Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('salary').innerText = agent.salary.toLocaleString() + " DQ";
    setSlider('salesBar', 'salesVal', agent.sales, agent.sGoal || 10000);
    setSlider('collBar', 'collVal', agent.coll, agent.cGoal || 10000);
    setSlider('mGoalBar', 'mGoalVal', agent.mGoal, agent.tGoal || 10000);
    
    document.getElementById('sGoalMax').innerText = "Goal: " + (agent.sGoal || 10000) + "$";
    document.getElementById('cGoalMax').innerText = "Goal: " + (agent.cGoal || 10000) + "$";
    loadToday();
}
function setSlider(barId, valId, val, max) {
    const pct = Math.min((val / max) * 100, 100);
    document.getElementById(barId).style.width = pct + "%";
    document.getElementById(valId).innerText = val + "$";
}

async function loadCustomers() {
    const r = await fetch(`${SCRIPT_URL}?action=getCustomers&agent=${agent.name}`);
    const data = await r.json();
    const sel = document.getElementById('custSelect');
    sel.innerHTML = `<option value="">${i18n[currentLang].selectCust}</option>`;
    data.forEach(c => {
        let opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
    });
}

function handleSelectChange(select) {
    if(select.value) {
        document.getElementById('modalTitle').innerText = select.value;
        document.getElementById('modal').classList.remove('hidden');
    }
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('custSelect').value = "";
}

function calcExchange() {
    const iq = document.getElementById('amtIQ').value;
    const rate = document.getElementById('rate').value || 1500;
    if(iq) document.getElementById('amtD').value = (iq / rate).toFixed(2);
}

async function loadToday() {
    const r = await fetch(`${SCRIPT_URL}?action=getToday&agent=${agent.name}`);
    const data = await r.json();
    const list = document.getElementById('todayList');
    let total = 0; list.innerHTML = "";
    data.forEach(i => {
        total += parseFloat(i.amt);
        list.innerHTML += `
            <div class="flex justify-between items-center bg-white/60 p-2 rounded-2xl border border-sky-900/10 mb-2 shadow-sm">
                <div class="w-24 text-center font-bold border-r-2 border-sky-100 text-lg">$ ${i.amt}</div>
                <div class="flex-1 text-center font-bold text-sky-900 text-sm">${i.cust}</div>
            </div>`;
    });
    document.getElementById('dayTotal').innerText = "$ " + total;
}

async function login() { performLogin(document.getElementById('user').value, document.getElementById('pass').value, false); }

async function sendData() {
    const btn = document.getElementById('sendBtn');
    btn.disabled = true; btn.innerText = "...";
    const payload = {
        agent: agent.name,
        customer: document.getElementById('modalTitle').innerText,
        amount: document.getElementById('amtD').value,
        note: document.getElementById('note').value
    };
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert(currentLang === 'ar' ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ù†ÛØ±Ø¯Ø±Ø§");
        closeModal();
        loadToday();
    } catch(e) { alert("Error"); }
    btn.disabled = false; btn.innerText = i18n[currentLang].sendBtn;
}
</script>
</body>
</html>
