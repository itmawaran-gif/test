<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>

<style>
body{font-family:tahoma;background:#f2f4f7;margin:0}
.container{max-width:500px;margin:auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 10px #0002;transition:background 0.3s}
h2{text-align:center;margin-bottom:10px}
label{display:block;margin-top:10px;font-weight:bold}
input,select,textarea,button{width:100%;padding:10px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#0a7cff;color:#fff;border:0;cursor:pointer;transition:0.2s}
button:hover{opacity:0.9}
button:disabled{background:#999;cursor:not-allowed}
.hidden{display:none}
.error{border-color:red;background:#ffecec}

/* زر التبديل */
#switcher{display:flex;gap:6px;margin-bottom:10px}
#switcher button{flex:1;padding:10px;font-weight:bold;color:#fff;border-radius:8px;border:none;transition:0.2s}
#switcher button.active{opacity:1;font-weight:bold}

/* ألوان الفورم */
#newForm{background:#e0f7ff;padding:10px;border-radius:8px;transition:0.3s}
#oldForm{background:#fff0e0;padding:10px;border-radius:8px;transition:0.3s}

/* زيارة */
#visitBox{text-align:center;margin:10px 0}
#startVisit{width:90px;height:90px;border-radius:50%;font-size:14px;font-weight:bold;background:#0a7cff;color:#fff;border:none;cursor:pointer;transition:0.3s}
#timer{margin-top:6px;font-weight:bold;font-size:16px}
</style>
</head>

<body>
<div class="container">

<!-- زر التبديل -->
<div id="switcher">
  <button id="btnNew" class="active" onclick="showForm('new')">عميل جديد</button>
  <button id="btnOld" onclick="showForm('old')">عميل دائمي</button>
</div>

<!-- زر بدء الزيارة -->
<div id="visitBox">
  <button id="startVisit">بدء<br>الزيارة</button>
  <div id="timer">⏱️ 0:00</div>
</div>

<!-- ===== عميل جديد ===== -->
<div id="newForm">

<h2>عميل جديد</h2>

<label>هل يمتلك زيت ريماكس - ئایا ڕۆنی ڕیماکس هەیەتی *</label>
<select id="useOil">
  <option value="">اختر</option>
  <option>نعم - بەڵێ</option>
  <option>لا - نەخێر</option>
</select>

<label>الاسم التجاري - ناوی بازرگانی *</label>
<input id="tradeName">

<label>اسم المالك - ناوی خاوەنەکەی *</label>
<input id="ownerName">

<label>العنوان ناونیشانەکە *</label>
<input id="address">

<label>رقم الهاتف - ژمارەی تەلەفۆن *</label>
<input id="phone" inputmode="numeric">

<label>الفئة - جۆر *</label>
<select id="category">
  <option value="">اختر</option>
  <option>كراج</option>
  <option>جملة</option>
  <option>مفرد</option>
</select>

<label>ملاحظة - تێبینی</label>
<textarea id="note"></textarea>

<label>التقييم - هەڵسەنگاندن *</label>
<select id="rate">
  <option value="">اختر</option>
  <option value="1">⭐</option>
  <option value="2">⭐⭐</option>
  <option value="3">⭐⭐⭐</option>
  <option value="4">⭐⭐⭐⭐</option>
  <option value="5">⭐⭐⭐⭐⭐</option>
</select>

<label>كل كم يوم زيارة - چەند ڕۆژ دوای سەردانەکە؟ *</label>
<input id="visitDays" inputmode="numeric">

<label>نوع الزيت من ماركة اخرى</label>
<input id="oilType">

<label>درجة الزيت</label>
<input id="oilGrade">

<label>كم المسافة التي يقطعها</label>
<select id="oilDistance">
  <option value="">اختر</option>
  <option>3K كم</option>
  <option>5K كم</option>
  <option>10K كم</option>
  <option>15K كم</option>
</select>

<label>سعر اللتر</label>
<input id="oilPrice" inputmode="numeric">

<label>صورة المتجر *</label>
<input type="file" id="newImage" accept="image/*" capture="environment">

<button id="sendNewBtn" onclick="sendNew()">إرسال</button>
<div id="msgNew"></div>

</div>

<!-- ===== عميل دائمي ===== -->
<div id="oldForm" class="hidden">

<h2>عميل دائمي</h2>

<label>اسم العميل</label>
<input id="oldName">

<label>هل تم عمل طلبية؟</label>
<select id="hasOrder" onchange="toggleOrder()">
  <option value="">اختر</option>
  <option>نعم</option>
  <option>لا</option>
</select>

<div id="orderYes" class="hidden">
  <label>مبلغ الطلبية</label>
  <input id="orderAmount" inputmode="numeric">
</div>

<div id="orderNo" class="hidden">
  <label>سبب عدم إنشاء طلبية</label>
  <input id="orderReason">
</div>

<label>هل تم قبض مبلغ؟</label>
<select id="hasCash" onchange="toggleCash()">
  <option value="">اختر</option>
  <option>نعم</option>
  <option>لا</option>
</select>

<div id="cashYes" class="hidden">
  <label>مبلغ القبض</label>
  <input id="cashAmount" inputmode="numeric">
</div>

<div id="cashNo" class="hidden">
  <label>سبب عدم القبض</label>
  <input id="cashReason">
</div>

<label>ملاحظة</label>
<textarea id="oldNote"></textarea>

<label>صورة *</label>
<input type="file" id="oldImage" accept="image/*" capture="environment">

<button id="sendOldBtn" onclick="sendOld()">إرسال</button>
<div id="msgOld"></div>

</div>

</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbw0l4qAtY-nYVznmwk9brxfZs64mn0ZHJG1yKJR51dt6l69fQiB_fkY10UNjcXJlgA/exec";
let visitTimer;
let uploadedImageData="";

// ===== تبديل الفورم =====
function showForm(type){
  const newBg="#e0f7ff", oldBg="#fff0e0";
  newForm.classList.toggle("hidden",type!=="new");
  oldForm.classList.toggle("hidden",type!=="old");
  btnNew.classList.toggle("active",type==="new");
  btnOld.classList.toggle("active",type==="old");
  document.querySelector(".container").style.background = type==="new"?newBg:oldBg;
}

// ===== بدء الزيارة =====
startVisit.onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    localStorage.visitStart=Date.now();
    localStorage.startLat=p.coords.latitude;
    localStorage.startLng=p.coords.longitude;
    runTimer();
    alert("✅ تم بدء الزيارة");
  });
};

// ===== عداد الوقت =====
function runTimer(){
  clearInterval(visitTimer);
  visitTimer=setInterval(()=>{
    if(!localStorage.visitStart)return;
    let d=Date.now()-localStorage.visitStart;
    let m=Math.floor(d/60000);
    let s=Math.floor((d%60000)/1000);
    timer.textContent=`⏱️ ${m}:${s.toString().padStart(2,"0")}`;
  },1000);
}
if(localStorage.visitStart) runTimer();

function visitDuration(){return Math.round((Date.now()-localStorage.visitStart)/60000);}

// ===== المسافة =====
function distance(lat1,lng1,lat2,lng2){
  const R=6371e3,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ===== قراءة الصورة =====
function readImage(input,cb){
  if(!input.files[0]) return cb("");
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(input.files[0]);
}

// ===== إعادة ضبط الفورم بعد الإرسال =====
function resetForm(formType){
  if(formType==="new"){
    ["tradeName","ownerName","useOil","address","phone","category","note","rate","visitDays","oilType","oilGrade","oilDistance","oilPrice","newImage"]
    .forEach(id=>{const el=document.getElementById(id);if(el) el.value=""});
  } else {
    ["oldName","hasOrder","orderAmount","orderReason","hasCash","cashAmount","cashReason","oldNote","oldImage"]
    .forEach(id=>{const el=document.getElementById(id);if(el) el.value=""});
  }
  uploadedImageData="";
  localStorage.visitStart=null;
  timer.textContent="⏱️ 0:00";
  clearInterval(visitTimer);
}

// ===== إرسال العميل الجديد =====
function sendNew(){
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgNew.textContent="❌ خارج موقع الزيارة"; return;
    }
    readImage(newImage,img=>{
      fetch(URL,{method:"POST",body:JSON.stringify({
        type:"new",
        repName:"مندوب 1",
        city:"مدينة 1",
        tradeName:tradeName.value,
        ownerName:ownerName.value,
        useOil:useOil.value,
        address:address.value,
        phone:phone.value,
        category:category.value,
        note:note.value,
        rate:rate.value,
        visitDays:visitDays.value,
        oilType:oilType.value,
        oilGrade:oilGrade.value,
        oilDistance:oilDistance.value,
        oilPrice:oilPrice.value,
        image:img,
        lat:p.coords.latitude,
        lng:p.coords.longitude,
        visitDuration:visitDuration()
      })}).then(r=>r.json()).then(res=>{
        msgNew.textContent="✅ تم الإرسال";
        resetForm("new");
      });
    });
  });
}

// ===== إرسال العميل الدائمي =====
function toggleOrder(){
  orderYes.classList.toggle("hidden",hasOrder.value!=="نعم");
  orderNo.classList.toggle("hidden",hasOrder.value!=="لا");
}
function toggleCash(){
  cashYes.classList.toggle("hidden",hasCash.value!=="نعم");
  cashNo.classList.toggle("hidden",hasCash.value!=="لا");
}
function sendOld(){
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgOld.textContent="❌ خارج موقع الزيارة"; return;
    }
    readImage(oldImage,img=>{
      fetch(URL,{method:"POST",body:JSON.stringify({
        type:"old",
        name:oldName.value,
        hasOrder:hasOrder.value,
        orderAmount:orderAmount.value,
        orderReason:orderReason.value,
        hasCash:hasCash.value,
        cashAmount:cashAmount.value,
        cashReason:cashReason.value,
        note:oldNote.value,
        image:img,
        lat:p.coords.latitude,
        lng:p.coords.longitude,
        visitDuration:visitDuration()
      })}).then(r=>r.json()).then(res=>{
        msgOld.textContent="✅ تم الإرسال";
        resetForm("old");
      });
    });
  });
}
</script>

