<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>

<style>
body{font-family:tahoma;background:#f2f4f7;margin:0}
.container{max-width:420px;margin:auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 10px #0002}
h2{text-align:center}
label{display:block;margin-top:10px;font-weight:bold}
input,select,textarea,button{width:100%;padding:10px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#0a7cff;color:#fff;border:0;cursor:pointer}
button:disabled{background:#999}
.hidden{display:none}
.error{border-color:red;background:#ffecec}

#switcher{display:flex;gap:6px;margin-bottom:10px}
#switcher button{background:#555}

#visitBox{text-align:center;margin:10px 0}
#startVisit{width:90px;height:90px;border-radius:50%;font-size:14px}
#timer{margin-top:6px;font-weight:bold}
</style>
</head>

<body>
<div class="container">

<!-- ===== التبديل ===== -->
<div id="switcher">
  <button onclick="showForm('new')">عميل جديد</button>
  <button onclick="showForm('old')">عميل دائمي</button>
</div>

<!-- ===== بدء الزيارة ===== -->
<div id="visitBox">
  <button id="startVisit">بدء<br>الزيارة</button>
  <div id="timer"></div>
</div>

<!-- ================== عميل جديد ================== -->
<div id="newForm">

<h2>عميل جديد</h2>

<label>الاسم التجاري *</label>
<input id="tradeName">

<label>اسم المالك *</label>
<input id="ownerName">

<label>العنوان *</label>
<input id="address">

<label>رقم الهاتف *</label>
<input id="phone">

<label>ملاحظة</label>
<textarea id="note"></textarea>

<label>صورة المتجر *</label>
<input type="file" id="newImage" accept="image/*" capture="environment">

<button id="sendNewBtn" onclick="sendNew()">إرسال</button>
<div id="msgNew"></div>
</div>

<!-- ================== عميل دائمي ================== -->
<div id="oldForm" class="hidden">

<h2>عميل دائمي</h2>

<label>اسم العميل</label>
<input id="oldName">

<label>هل تم عمل طلبية؟</label>
<select id="hasOrder" onchange="toggleOrder()">
  <option value="">اختر</option>
  <option>نعم</option>
  <option>لا</option>
</select>

<div id="orderYes" class="hidden">
  <label>مبلغ الطلبية</label>
  <input id="orderAmount" inputmode="numeric">
</div>

<div id="orderNo" class="hidden">
  <label>سبب عدم إنشاء طلبية</label>
  <input id="orderReason">
</div>

<label>هل تم قبض مبلغ؟</label>
<select id="hasCash" onchange="toggleCash()">
  <option value="">اختر</option>
  <option>نعم</option>
  <option>لا</option>
</select>

<div id="cashYes" class="hidden">
  <label>مبلغ القبض</label>
  <input id="cashAmount" inputmode="numeric">
</div>

<div id="cashNo" class="hidden">
  <label>سبب عدم القبض</label>
  <input id="cashReason">
</div>

<label>ملاحظة</label>
<textarea id="oldNote"></textarea>

<label>صورة *</label>
<input type="file" id="oldImage" accept="image/*" capture="environment">

<button id="sendOldBtn" onclick="sendOld()">إرسال</button>
<div id="msgOld"></div>
</div>

</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbwLxdZ27xXcPcJPDAxphwPYuEK1ICgj4qkayh00QBeDBR4YbFeX9_-rcNbPIdvJ3wsG/exec";
let visitTimer;

// ===== التبديل =====
function showForm(t){
  newForm.classList.toggle("hidden",t!=="new");
  oldForm.classList.toggle("hidden",t!=="old");
}

// ===== بدء الزيارة =====
startVisit.onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    localStorage.visitStart=Date.now();
    localStorage.startLat=p.coords.latitude;
    localStorage.startLng=p.coords.longitude;
    alert("✅ تم بدء الزيارة");
    runTimer();
  });
};

function runTimer(){
  clearInterval(visitTimer);
  visitTimer=setInterval(()=>{
    if(!localStorage.visitStart)return;
    let d=Date.now()-localStorage.visitStart;
    let m=Math.floor(d/60000);
    let s=Math.floor((d%60000)/1000);
    timer.textContent=`⏱️ ${m}:${s.toString().padStart(2,"0")}`;
  },1000);
}
if(localStorage.visitStart)runTimer();

// ===== مسافة =====
function distance(lat1,lng1,lat2,lng2){
  const R=6371e3,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ===== مدة =====
function visitDuration(){
  return Math.round((Date.now()-localStorage.visitStart)/60000);
}

// ===== صورة =====
function readImage(input,cb){
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(input.files[0]);
}

// ===== إرسال عميل جديد =====
function sendNew(){
  type: "new",  
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgNew.textContent="❌ خارج موقع الزيارة";
      return;
    }
    readImage(newImage,img=>{
      fetch(URL,{
        method:"POST",
        body:JSON.stringify({
          type:"new",
          tradeName:tradeName.value,
          ownerName:ownerName.value,
          address:address.value,
          phone:phone.value,
          note:note.value,
          image:img,
          lat:p.coords.latitude,
          lng:p.coords.longitude,
          visitDuration:visitDuration()
        })
      }).then(r=>r.json())
      .then(res=>msgNew.textContent="✅ تم الإرسال");
    });
  });
}

// ===== عميل دائمي =====
function toggleOrder(){
  orderYes.classList.toggle("hidden",hasOrder.value!=="نعم");
  orderNo.classList.toggle("hidden",hasOrder.value!=="لا");
}
function toggleCash(){
  cashYes.classList.toggle("hidden",hasCash.value!=="نعم");
  cashNo.classList.toggle("hidden",hasCash.value!=="لا");
}

function sendOld(){
  type: "old", 
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgOld.textContent="❌ خارج موقع الزيارة";
      return;
    }
    readImage(oldImage,img=>{
      fetch(URL,{
        method:"POST",
        body:JSON.stringify({
          type:"old",
          name:oldName.value,
          hasOrder:hasOrder.value,
          orderAmount:orderAmount.value,
          orderReason:orderReason.value,
          hasCash:hasCash.value,
          cashAmount:cashAmount.value,
          cashReason:cashReason.value,
          note:oldNote.value,
          image:img,
          lat:p.coords.latitude,
          lng:p.coords.longitude,
          visitDuration:visitDuration()
        })
      }).then(r=>r.json())
      .then(res=>msgOld.textContent="✅ تم الإرسال");
    });
  });
}
</script>
</body>
</html>
