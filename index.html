<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>
<style>
    body { font-family:tahoma; background:#f2f4f7; margin:0; padding: 10px; }
    .container { max-width:420px; margin:auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 10px #0002; position: relative; }
    
    /* تصميم النافذة المنبثقة الإجبارية */
    #appModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); display: flex; align-items: center;
        justify-content: center; z-index: 9999;
    }
    .modal-content {
        background: #fff; padding: 30px; border-radius: 15px;
        text-align: center; width: 80%; max-width: 300px;
    }
    .modal-content h3 { margin-top: 0; color: #333; }
    .modal-content p { font-size: 14px; color: #666; margin-bottom: 20px; }
    #openAppBtn {
        background: #28a745; color: #fff; border: 0; padding: 12px 20px;
        border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;
    }

    .lang-switcher { margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; text-align: center; }
    .lang-switcher select { width: auto; padding: 8px 15px; font-size: 14px; cursor: pointer; border-radius: 20px; background: #f8f9fa; border: 1px solid #ddd; }
    h2 { text-align:center; color: #333; margin-bottom: 20px; }
    label { display:block; margin-top:10px; font-weight:bold; font-size: 14px; color: #444; }
    input, select, textarea, button { width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid #ccc; font-size:16px; box-sizing: border-box; }
    button { background:#0a7cff; color:#fff; border:0; margin-top:15px; cursor:pointer; font-weight: bold; }
    button:disabled { background:#999 !important; cursor:not-allowed; opacity: 0.6; }
    #msg { text-align:center; margin-top:10px; font-weight:bold; font-size: 14px; }
    .hidden { display:none !important; }
    .visit-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; flex-direction: column; }
    #startVisitBtn { width: 90px; height: 90px; border-radius: 50%; background: #28a745; color: white; border: none; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: 0.3s; }
    #startVisitBtn.active { background: #dc3545; animation: pulse 1.5s infinite; }
    #cancelVisitBtn { width: auto; padding: 6px 12px; background: #6c757d; font-size: 11px; margin-top: 5px; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav-tabs button { margin-top: 0; background: #eee; color: #333; flex: 1; font-size: 14px; border: 1px solid #ddd; }
    .nav-tabs button.active { background: #0a7cff; color: white; border-color: #0a7cff; }
    #timerDisplay { text-align: center; font-size: 22px; font-weight: bold; color: #dc3545; font-family: monospace; margin-bottom: 10px; }
</style>
</head>
<body>

<div id="appModal" class="hidden">
    <div class="modal-content">
        <h3 id="modalTitle">بەیانی باش - صباح الخير</h3>
        <p id="modalBody">هل انت مستعد ليوم جديد - ئامادەی بۆ ڕۆژێکی نوێ</p>
        <button id="openAppBtn" onclick="triggerAppOpening()">OK</button>
    </div>
</div>

<div class="container">
    <div id="login">
        <h2 data-key="login_title">تسجيل الدخول</h2>
        <label data-key="rep_name_label">اسم المندوب *</label>
        <input id="repName">
        <label data-key="city_label">المدينة *</label>
        <input id="city">
        <button onclick="saveLogin()" data-key="login_btn">دخول للنظام</button>
    </div>

    <div id="formBox" class="hidden">
        <div class="nav-tabs">
            <button id="tabNew" class="active" onclick="switchForm('new')" data-key="tab_new">عميل جديد</button>
            <button id="tabRegular" onclick="switchForm('regular')" data-key="tab_regular">عميل دائمي</button>
        </div>

        <div id="timerDisplay" class="hidden">00:00:00</div>
        <div class="visit-controls">
            <button id="startVisitBtn" onclick="toggleVisit()" data-key="start_visit">بدء<br>الزيارة</button>
            <button id="cancelVisitBtn" class="hidden" onclick="cancelVisit()" data-key="cancel_visit">إلغاء الزيارة ✖</button>
        </div>

        <div id="newClientForm">
            <label data-key="has_oil_label">هل يمتلك زيت ريماكس؟ *</label>
            <select id="useOil">
                <option value="" data-key="choose">اختر</option>
                <option value="نعم" data-key="yes">نعم</option>
                <option value="لا" data-key="no">لا</option>
            </select>
            <label data-key="trade_name_label">الاسم التجاري *</label>
            <input id="tradeName">
            <label data-key="owner_name_label">اسم المالك *</label>
            <input id="ownerName">
            <label data-key="address_label">العنوان *</label>
            <input id="address">
            <label data-key="phone_label">رقم الهاتف *</label>
            <input id="phone" inputmode="numeric">
            <label data-key="category_label">الفئة *</label>
            <select id="category">
                <option value="" data-key="choose">اختر</option>
                <option value="كراج" data-key="garage">كراج</option>
                <option value="جملة" data-key="wholesale">جملة</option>
                <option value="مفرد" data-key="retail">مفرد</option>
            </select>
            <label data-key="note_label">ملاحظة</label>
            <textarea id="note"></textarea>
            <label data-key="rate_label">التقييم *</label>
            <select id="rate">
                <option value="" data-key="choose">اختر</option>
                <option value="1">⭐</option><option value="2">⭐⭐</option><option value="3">⭐⭐⭐</option><option value="4">⭐⭐⭐⭐</option><option value="5">⭐⭐⭐⭐⭐</option>
            </select>
            <label data-key="visit_days_label">كل كم يوم زيارة *</label>
            <input id="visitDays" inputmode="numeric">
            <hr style="opacity: 0.2; margin: 20px 0;">
            <label data-key="other_oil_label">نوع الزيت ماركة أخرى</label>
            <input id="oilType">
            <label data-key="oil_grade_label">درجة الزيت</label>
            <input id="oilGrade">
            <label data-key="distance_label">المسافة</label>
            <select id="oilDistance">
                <option value="" data-key="choose">اختر</option>
                <option>3K كم</option><option>5K كم</option><option>10K كم</option><option>15K كم</option>
            </select>
            <label data-key="liter_price_label">سعر اللتر</label>
            <input id="oilPrice" inputmode="numeric">
            <label data-key="store_img_label">صورة المتجر *</label>
            <input type="file" id="imageInputNew" accept="image/*" capture="environment">
        </div>

        <div id="regularClientForm" class="hidden">
            <label data-key="client_name_label">اسم العميل *</label>
            <input id="reg_clientName">
            <label data-key="has_order_label">هل تم عمل طلبية؟</label>
            <select id="reg_hasOrder" onchange="toggleOrderFields()">
                <option value="لا" data-key="no">لا</option><option value="نعم" data-key="yes">نعم</option>
            </select>
            <div id="orderAmountBox" class="hidden">
                <label data-key="order_amount_label">مبلغ الطلبية *</label>
                <input id="reg_orderAmount" type="number">
            </div>
            <div id="orderReasonBox">
                <label data-key="no_order_reason">سبب عدم إنشاء طلبية *</label>
                <input id="reg_orderReason">
            </div>
            <label data-key="has_payment_label">هل تم قبض مبلغ؟</label>
            <select id="reg_hasPayment" onchange="togglePaymentFields()">
                <option value="لا" data-key="no">لا</option><option value="نعم" data-key="yes">نعم</option>
            </select>
            <div id="payAmountBox" class="hidden">
                <label data-key="pay_amount_label">مبلغ القبض *</label>
                <input id="reg_payAmount" type="number">
            </div>
            <div id="payReasonBox">
                <label data-key="no_pay_reason">سبب عدم القبض *</label>
                <input id="reg_payReason">
            </div>
            <label data-key="note_label">الملاحظة</label>
            <textarea id="reg_note"></textarea>
            <label data-key="take_photo_label">التقاط صورة *</label>
            <input type="file" id="imageInputReg" accept="image/*" capture="environment">
        </div>

        <button id="sendBtn" onclick="handleSend()" data-key="send_data_btn">إرسال البيانات</button>
        <div id="msg"></div>
    </div>

    <div class="lang-switcher">
        <select id="langSelect" onchange="changeLanguage(this.value)">
            <option value="ar">العربية (Arabic)</option>
            <option value="ku">کوردی (Soranî)</option>
        </select>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBWsE8YvQcYkdUbWHaLJSAfqsEZmSCENN6jtuUKF_1t8zR-JwBpo-dZVVVivpigav5/exec";
let currentMode = 'new';
let visitStartTime = localStorage.getItem('visitStartTime') ? parseInt(localStorage.getItem('visitStartTime')) : null;
let startCoords = localStorage.getItem('startCoords') ? JSON.parse(localStorage.getItem('startCoords')) : null;
let timerInterval;
let isSending = false;

const translations = {
    ar: {
        modal_title: "تنبيه اليوم", modal_body: "يجب فتح تطبيق Traccar لضمان تسجيل الموقع بشكل صحيح.", modal_btn: "فتح التطبيق الآن",
        login_title: "تسجيل الدخول", rep_name_label: "اسم المندوب *", city_label: "المدينة *", login_btn: "دخول للنظام",
        tab_new: "عميل جديد", tab_regular: "عميل دائمي", start_visit: "بدء<br>الزيارة", active_visit: "زيارة<br>جارية", 
        cancel_visit: "إلغاء الزيارة ✖", has_oil_label: "هل يمتلك زيت ريماكس؟ *", choose: "اختر", yes: "نعم", no: "لا",
        trade_name_label: "الاسم التجاري *", owner_name_label: "اسم المالك *", address_label: "العنوان *", phone_label: "رقم الهاتف *",
        category_label: "الفئة *", garage: "كراج", wholesale: "جملة", retail: "مفرد", note_label: "ملاحظة",
        rate_label: "التقييم *", visit_days_label: "كل كم يوم زيارة *", other_oil_label: "نوع الزيت ماركة أخرى",
        oil_grade_label: "درجة الزيت", distance_label: "المسافة", liter_price_label: "سعر اللتر", store_img_label: "صورة المتجر *",
        client_name_label: "اسم العميل *", has_order_label: "هل تم عمل طلبية؟", order_amount_label: "مبلغ الطلبية *",
        no_order_reason: "سبب عدم إنشاء طلبية *", has_payment_label: "هل تم قبض مبلغ؟", pay_amount_label: "مبلغ القبض *",
        no_pay_reason: "سبب عدم القبض *", take_photo_label: "التقاط صورة *", send_data_btn: "إرسال البيانات",
        alert_fill: "يرجى إدخال البيانات", alert_geo: "يجب تفعيل الموقع لبدء الزيارة", alert_cancel: "سيتم حذف توقيت الزيارة الحالية، هل أنت متأكد؟",
        alert_dist: "المسافة بعيدة جداً", sending: "جاري الإرسال...", wait: "⏳ يرجى الانتظار، يتم رفع البيانات...", success: "✅ تم بنجاح", loading: "جاري تحديد الموقع..."
    },
    ku: {
        modal_title: "ئاگاداری ڕۆژ", modal_body: "دەبێت ئەپی Traccar بکەیتەوە بۆ دڵنیابوون لە تۆمارکردنی شوێن.", modal_btn: "ئێستا ئەپەکە بکەرەوە",
        login_title: "چوونە ژوورەوە", rep_name_label: "ناوی نوێنەر *", city_label: "شار *", login_btn: "چوونە ناو سیستم",
        tab_new: "کڕیاری نوێ", tab_regular: "کڕیاری هەمیشەیی", start_visit: "دەستپێکی<br>سەردان", active_visit: "سەردان<br>بەردەوامە",
        cancel_visit: "سڕینەوەی سەردان ✖", has_oil_label: "ئایا زەیتی ڕیماکسی هەیە؟ *", choose: "هەڵبژێرە", yes: "بەڵێ", no: "نەخێر",
        trade_name_label: "ناوی بازرگانی *", owner_name_label: "ناوی خاوەن *", address_label: "ناونیشان *", phone_label: "ژمارەی مۆبایل *",
        category_label: "پۆلێن *", garage: "گەراج", wholesale: "کۆمەڵ", retail: "تاک", note_label: "تێبینی",
        rate_label: "هەڵسەنگاندن *", visit_days_label: "چەند ڕۆژ جارێک سەردان *", other_oil_label: "جۆری زەیتی مارکەیەکی تر",
        oil_grade_label: "پلەی زەیت", distance_label: "مەودا", liter_price_label: "نرخی لیتر", store_img_label: "وێنەی فرۆشگا *",
        client_name_label: "ناوی کڕیار *", has_order_label: "ئایا داواکاری تۆمارکرا؟", order_amount_label: "بڕی داواکاری *",
        no_order_reason: "هۆکاری تۆمارنەکردنی داواکاری *", has_payment_label: "ئایا پارە وەرگیرا؟", pay_amount_label: "بڕی وەرگیراو *",
        no_pay_reason: "هۆکاری وەرنەگرتنی پارە *", take_photo_label: "وێنەگرتن *", send_data_btn: "ناردنی زانیارییەکان",
        alert_fill: "تکایە زانیارییەکان پڕ بکەرەوە", alert_geo: "دەبێت شوێنێنەکەت چالاک بکەیت", alert_cancel: "کاتی سەردانەکە دەسڕێتەوە، دڵنیایت؟",
        alert_dist: "مەوداکە زۆر دوورە", sending: "خەریکی ناردنە...", wait: "⏳ تکایە چاوەڕێ بکە، زانیارییەکان بەرزدەکرێنەوە...", success: "✅ بە سەرکەوتوویی تەواو بوو", loading: "دیاریکردنی شوێن..."
    }
};

// وظيفة التحقق من الحاجة لفتح التطبيق
function checkDailyAppModal() {
    const today = new Date().toLocaleDateString();
    const lastOpen = localStorage.getItem('lastTraccarOpenDate');
    const lang = localStorage.getItem('appLang') || 'ar';

    if (lastOpen !== today) {
        // إظهار النافذة المنبثقة
        const modal = document.getElementById('appModal');
        modal.classList.remove('hidden');
        
        // تحديث نصوص النافذة حسب اللغة
        document.getElementById('modalTitle').innerText = translations[lang].modal_title;
        document.getElementById('modalBody').innerText = translations[lang].modal_body;
        document.getElementById('openAppBtn').innerText = translations[lang].modal_btn;
    }
}

// وظيفة يتم استدعاؤها عند الضغط على زر "فتح" داخل النافذة
function triggerAppOpening() {
    const today = new Date().toLocaleDateString();
    const appPackage = "org.traccar.client";
    
    // محاولة فتح التطبيق
    window.location.href = "intent://#Intent;scheme=org.traccar.client;package=" + appPackage + ";end";
    
    // إخفاء النافذة وتسجيل الفتح في الذاكرة
    document.getElementById('appModal').classList.add('hidden');
    localStorage.setItem('lastTraccarOpenDate', today);
}

window.onload = () => {
    // تشغيل التحقق اليومي
    checkDailyAppModal();

    const savedLang = localStorage.getItem('appLang') || 'ar';
    document.getElementById('langSelect').value = savedLang;
    changeLanguage(savedLang);
    if(localStorage.repName) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('formBox').classList.remove('hidden');
        if(visitStartTime) resumeVisit();
    }
};

// ... بقية وظائف الكود الخاصة بك (changeLanguage, saveLogin, toggleVisit, إلخ) ...

function changeLanguage(lang) {
    localStorage.setItem('appLang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = "rtl"; 
    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        if (translations[lang][key]) {
            if (el.tagName === 'BUTTON' && key === 'start_visit' && visitStartTime) {
                el.innerHTML = translations[lang]['active_visit'];
            } else {
                el.innerHTML = translations[lang][key];
            }
        }
    });
}

function saveLogin() {
    const lang = localStorage.getItem('appLang') || 'ar';
    const r = document.getElementById('repName').value;
    const c = document.getElementById('city').value;
    if(!r || !c) return alert(translations[lang].alert_fill);
    localStorage.repName = r; localStorage.city = c;
    location.reload();
}

function switchForm(mode) {
    currentMode = mode;
    document.getElementById('newClientForm').classList.toggle('hidden', mode !== 'new');
    document.getElementById('regularClientForm').classList.toggle('hidden', mode !== 'regular');
    document.getElementById('tabNew').classList.toggle('active', mode === 'new');
    document.getElementById('tabRegular').classList.toggle('active', mode === 'regular');
}

function toggleVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    const btn = document.getElementById('startVisitBtn');
    
    if(!visitStartTime) {
        btn.disabled = true;
        btn.innerHTML = translations[lang].loading;
        
        navigator.geolocation.getCurrentPosition(pos => {
            visitStartTime = Date.now();
            startCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            localStorage.setItem('visitStartTime', visitStartTime);
            localStorage.setItem('startCoords', JSON.stringify(startCoords));
            resumeVisit();
        }, () => {
            alert(translations[lang].alert_geo);
            btn.disabled = false;
            btn.innerHTML = translations[lang].start_visit;
        }, { enableHighAccuracy: true });
    }
}

function resumeVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    document.getElementById('timerDisplay').classList.remove('hidden');
    document.getElementById('cancelVisitBtn').classList.remove('hidden');
    const btn = document.getElementById('startVisitBtn');
    btn.classList.add('active');
    btn.innerHTML = translations[lang].active_visit;
    btn.disabled = true;

    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        const diff = Date.now() - visitStartTime;
        const h = Math.floor(diff/3600000).toString().padStart(2,'0');
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = `${h}:${m}:${s}`;
    }, 1000);
}

function cancelVisit() {
    const lang = localStorage.getItem('appLang') || 'ar';
    if(confirm(translations[lang].alert_cancel)) {
        clearInterval(timerInterval);
        localStorage.removeItem('visitStartTime');
        localStorage.removeItem('startCoords');
        visitStartTime = null;
        startCoords = null;
        const btn = document.getElementById('startVisitBtn');
        btn.classList.remove('active');
        btn.disabled = false;
        btn.innerHTML = translations[lang].start_visit;
        document.getElementById('timerDisplay').classList.add('hidden');
        document.getElementById('cancelVisitBtn').classList.add('hidden');
    }
}

function toggleOrderFields() {
    const val = document.getElementById('reg_hasOrder').value;
    document.getElementById('orderAmountBox').classList.toggle('hidden', val === 'لا');
    document.getElementById('orderReasonBox').classList.toggle('hidden', val === 'نعم');
}

function togglePaymentFields() {
    const val = document.getElementById('reg_hasPayment').value;
    document.getElementById('payAmountBox').classList.toggle('hidden', val === 'لا');
    document.getElementById('payReasonBox').classList.toggle('hidden', val === 'نعم');
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function handleSend() {
    if(isSending) return;
    const lang = localStorage.getItem('appLang') || 'ar';
    if(!visitStartTime) return alert(translations[lang].start_visit.replace('<br>', ' '));
    const btn = document.getElementById('sendBtn');
    const msg = document.getElementById('msg');
    isSending = true;
    btn.disabled = true;
    btn.innerText = translations[lang].loading;

    navigator.geolocation.getCurrentPosition(async pos => {
        const dist = getDistance(startCoords.lat, startCoords.lng, pos.coords.latitude, pos.coords.longitude);
        if(dist > 2000) { 
            alert(`${translations[lang].alert_dist} (${Math.round(dist)}m).`); 
            isSending = false;
            btn.disabled = false;
            btn.innerText = translations[lang].send_data_btn;
            return; 
        }

        btn.innerText = translations[lang].sending;
        msg.innerText = translations[lang].wait;
        const durationMin = Math.floor((Date.now() - visitStartTime) / 60000) + " min";
        let data = { sheetName: currentMode === 'new' ? 'data' : 'Clients', repName: localStorage.repName, city: localStorage.city, duration: durationMin, lat: pos.coords.latitude, lng: pos.coords.longitude };
        const fileInput = currentMode === 'new' ? document.getElementById('imageInputNew') : document.getElementById('imageInputReg');
        
        if(fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);
            reader.onload = () => {
                if(currentMode === 'new') {
                    data.tradeName = document.getElementById('tradeName').value;
                    data.ownerName = document.getElementById('ownerName').value;
                    data.useOil = document.getElementById('useOil').value;
                    data.address = document.getElementById('address').value;
                    data.phone = document.getElementById('phone').value;
                    data.category = document.getElementById('category').value;
                    data.note = document.getElementById('note').value;
                    data.rate = document.getElementById('rate').value;
                    data.visitDays = document.getElementById('visitDays').value;
                    data.oilType = document.getElementById('oilType').value;
                    data.oilGrade = document.getElementById('oilGrade').value;
                    data.oilDistance = document.getElementById('oilDistance').value;
                    data.oilPrice = document.getElementById('oilPrice').value;
                } else {
                    data.clientName = document.getElementById('reg_clientName').value;
                    data.hasOrder = document.getElementById('reg_hasOrder').value;
                    data.orderAmount = document.getElementById('reg_orderAmount').value;
                    data.orderReason = document.getElementById('reg_orderReason').value;
                    data.hasPayment = document.getElementById('reg_hasPayment').value;
                    data.payAmount = document.getElementById('reg_payAmount').value;
                    data.payReason = document.getElementById('reg_payReason').value;
                    data.note = document.getElementById('reg_note').value;
                }
                data.image = reader.result;
                sendToGoogle(data);
            };
        } else {
            alert(translations[lang].take_photo_label);
            isSending = false;
            btn.disabled = false;
            btn.innerText = translations[lang].send_data_btn;
            msg.innerText = "";
        }
    }, () => {
        alert(translations[lang].alert_geo);
        isSending = false;
        btn.disabled = false;
        btn.innerText = translations[lang].send_data_btn;
    });
}

function sendToGoogle(data) {
    const lang = localStorage.getItem('appLang') || 'ar';
    fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) })
    .then(() => {
        alert(translations[lang].success);
        localStorage.removeItem('visitStartTime');
        localStorage.removeItem('startCoords');
        location.reload();
    })
    .catch(() => {
        alert("Error");
        isSending = false;
        document.getElementById('sendBtn').disabled = false;
    });
}
</script>
</body>
</html>
