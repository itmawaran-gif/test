<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MAWARAN CO</title>

<style>
body{font-family:tahoma;background:#f2f4f7;margin:0}
.container{max-width:500px;margin:auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 10px #0002;transition:background 0.3s}
h2{text-align:center;margin-bottom:10px}
label{display:block;margin-top:10px;font-weight:bold}
input,select,textarea,button{width:100%;padding:10px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#0a7cff;color:#fff;border:0;cursor:pointer;transition:0.2s}
button:hover{opacity:0.9}
button:disabled{background:#999;cursor:not-allowed}
.hidden{display:none}
.error{border-color:red;background:#ffecec}

/* Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
#switcher{display:flex;gap:6px;margin-bottom:10px}
#switcher button{flex:1;padding:10px;font-weight:bold;color:#fff;border-radius:8px;border:none;transition:0.2s}
#switcher button.active{opacity:1;font-weight:bold}

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙˆØ±Ù… */
#newForm{background:#e0f7ff;padding:10px;border-radius:8px;transition:0.3s}
#oldForm{background:#fff0e0;padding:10px;border-radius:8px;transition:0.3s}

/* Ø²ÙŠØ§Ø±Ø© */
#visitBox{text-align:center;margin:10px 0}
#startVisit{width:90px;height:90px;border-radius:50%;font-size:14px;font-weight:bold;background:#0a7cff;color:#fff;border:none;cursor:pointer;transition:0.3s}
#timer{margin-top:6px;font-weight:bold;font-size:16px}
</style>
</head>

<body>
<div class="container">

<!-- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ -->
<div id="switcher">
  <button id="btnNew" class="active" onclick="showForm('new')">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
  <button id="btnOld" onclick="showForm('old')">Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ</button>
</div>

<!-- Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© -->
<div id="visitBox">
  <button id="startVisit">Ø¨Ø¯Ø¡<br>Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
  <div id="timer">â±ï¸ 0:00</div>
</div>

<!-- ===== Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ===== -->
<div id="newForm">

<h2>Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>

<label>Ù‡Ù„ ÙŠÙ…ØªÙ„Ùƒ Ø²ÙŠØª Ø±ÙŠÙ…Ø§ÙƒØ³ - Ø¦Ø§ÛŒØ§ Ú•Û†Ù†ÛŒ Ú•ÛŒÙ…Ø§Ú©Ø³ Ù‡Û•ÛŒÛ•ØªÛŒ *</label>
<select id="useOil">
  <option value="">Ø§Ø®ØªØ±</option>
  <option>Ù†Ø¹Ù… - Ø¨Û•ÚµÛ</option>
  <option>Ù„Ø§ - Ù†Û•Ø®ÛØ±</option>
</select>

<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ - Ù†Ø§ÙˆÛŒ Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ *</label>
<input id="tradeName">

<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ - Ù†Ø§ÙˆÛŒ Ø®Ø§ÙˆÛ•Ù†Û•Ú©Û•ÛŒ *</label>
<input id="ownerName">

<label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†Û•Ú©Û• *</label>
<input id="address">

<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ - Ú˜Ù…Ø§Ø±Û•ÛŒ ØªÛ•Ù„Û•ÙÛ†Ù† *</label>
<input id="phone" inputmode="numeric">

<label>Ø§Ù„ÙØ¦Ø© - Ø¬Û†Ø± *</label>
<select id="category">
  <option value="">Ø§Ø®ØªØ±</option>
  <option>ÙƒØ±Ø§Ø¬</option>
  <option>Ø¬Ù…Ù„Ø©</option>
  <option>Ù…ÙØ±Ø¯</option>
</select>

<label>Ù…Ù„Ø§Ø­Ø¸Ø© - ØªÛØ¨ÛŒÙ†ÛŒ</label>
<textarea id="note"></textarea>

<label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… - Ù‡Û•ÚµØ³Û•Ù†Ú¯Ø§Ù†Ø¯Ù† *</label>
<select id="rate">
  <option value="">Ø§Ø®ØªØ±</option>
  <option value="1">â­</option>
  <option value="2">â­â­</option>
  <option value="3">â­â­â­</option>
  <option value="4">â­â­â­â­</option>
  <option value="5">â­â­â­â­â­</option>
</select>

<label>ÙƒÙ„ ÙƒÙ… ÙŠÙˆÙ… Ø²ÙŠØ§Ø±Ø© - Ú†Û•Ù†Ø¯ Ú•Û†Ú˜ Ø¯ÙˆØ§ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†Û•Ú©Û•ØŸ *</label>
<input id="visitDays" inputmode="numeric">

<label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØª Ù…Ù† Ù…Ø§Ø±ÙƒØ© Ø§Ø®Ø±Ù‰</label>
<input id="oilType">

<label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø²ÙŠØª</label>
<input id="oilGrade">

<label>ÙƒÙ… Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙŠ ÙŠÙ‚Ø·Ø¹Ù‡Ø§</label>
<select id="oilDistance">
  <option value="">Ø§Ø®ØªØ±</option>
  <option>3K ÙƒÙ…</option>
  <option>5K ÙƒÙ…</option>
  <option>10K ÙƒÙ…</option>
  <option>15K ÙƒÙ…</option>
</select>

<label>Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ±</label>
<input id="oilPrice" inputmode="numeric">

<label>ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ¬Ø± *</label>
<input type="file" id="newImage" accept="image/*" capture="environment">

<button id="sendNewBtn" onclick="sendNew()">Ø¥Ø±Ø³Ø§Ù„</button>
<div id="msgNew"></div>

</div>

<!-- ===== Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ ===== -->
<div id="oldForm" class="hidden">

<h2>Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ</h2>

<label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
<input id="oldName">

<label>Ù‡Ù„ ØªÙ… Ø¹Ù…Ù„ Ø·Ù„Ø¨ÙŠØ©ØŸ</label>
<select id="hasOrder" onchange="toggleOrder()">
  <option value="">Ø§Ø®ØªØ±</option>
  <option>Ù†Ø¹Ù…</option>
  <option>Ù„Ø§</option>
</select>

<div id="orderYes" class="hidden">
  <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</label>
  <input id="orderAmount" inputmode="numeric">
</div>

<div id="orderNo" class="hidden">
  <label>Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ©</label>
  <input id="orderReason">
</div>

<label>Ù‡Ù„ ØªÙ… Ù‚Ø¨Ø¶ Ù…Ø¨Ù„ØºØŸ</label>
<select id="hasCash" onchange="toggleCash()">
  <option value="">Ø§Ø®ØªØ±</option>
  <option>Ù†Ø¹Ù…</option>
  <option>Ù„Ø§</option>
</select>

<div id="cashYes" class="hidden">
  <label>Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¨Ø¶</label>
  <input id="cashAmount" inputmode="numeric">
</div>

<div id="cashNo" class="hidden">
  <label>Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¨Ø¶</label>
  <input id="cashReason">
</div>

<label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
<textarea id="oldNote"></textarea>

<label>ØµÙˆØ±Ø© *</label>
<input type="file" id="oldImage" accept="image/*" capture="environment">

<button id="sendOldBtn" onclick="sendOld()">Ø¥Ø±Ø³Ø§Ù„</button>
<div id="msgOld"></div>

</div>

</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbwKg-VeCTqyk3nFKf7GchKp60d5UfVyxsbl3DDW4XUOM4tC1LwuyOMQm_gr79eFwmMF/exec";
let visitTimer;

// ===== Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙÙˆØ±Ù…ÙŠÙ† =====
function showForm(type){
  const newBg="#e0f7ff", oldBg="#fff0e0";
  newForm.classList.toggle("hidden",type!=="new");
  oldForm.classList.toggle("hidden",type!=="old");
  btnNew.classList.toggle("active",type==="new");
  btnOld.classList.toggle("active",type==="old");
  document.querySelector(".container").style.background = type==="new"?newBg:oldBg;
}

// ===== Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© =====
startVisit.onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    localStorage.visitStart=Date.now();
    localStorage.startLat=p.coords.latitude;
    localStorage.startLng=p.coords.longitude;
    runTimer();
    alert("âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©");
  });
};

function runTimer(){
  clearInterval(visitTimer);
  visitTimer=setInterval(()=>{
    if(!localStorage.visitStart)return;
    let d=Date.now()-localStorage.visitStart;
    let m=Math.floor(d/60000);
    let s=Math.floor((d%60000)/1000);
    timer.textContent=`â±ï¸ ${m}:${s.toString().padStart(2,"0")}`;
  },1000);
}
if(localStorage.visitStart) runTimer();

// ===== Ø§Ù„Ù…Ø³Ø§ÙØ© =====
function distance(lat1,lng1,lat2,lng2){
  const R=6371e3,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ===== Ù…Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø© =====
function visitDuration(){
  return Math.round((Date.now()-localStorage.visitStart)/60000);
}

// ===== Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© =====
function readImage(input,cb){
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(input.files[0]);
}

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ =====
function sendNew(){
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgNew.textContent="âŒ Ø®Ø§Ø±Ø¬ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©";
      return;
    }
    readImage(newImage,img=>{
      fetch(URL,{
        method:"POST",
        body:JSON.stringify({
          type:"new",        // ğŸ‘ˆ Ù…Ù‡Ù…
          repName:"Ù…Ù†Ø¯ÙˆØ¨ 1", // Ø£Ø¶Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯
          city:"Ù…Ø¯ÙŠÙ†Ø© 1",    // Ø£Ø¶Ù Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
          tradeName:tradeName.value,
          ownerName:ownerName.value,
          useOil:useOil.value,
          address:address.value,
          phone:phone.value,
          category:category.value,
          note:note.value,
          rate:rate.value,
          visitDays:visitDays.value,
          oilType:oilType.value,
          oilGrade:oilGrade.value,
          oilDistance:oilDistance.value,
          oilPrice:oilPrice.value,
          image:img,
          lat:p.coords.latitude,
          lng:p.coords.longitude,
          visitDuration:visitDuration()
        })
      }).then(r=>r.json())
      .then(res=>msgNew.textContent="âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    });
  });
}

// ===== Ø¹Ù…ÙŠÙ„ Ø¯Ø§Ø¦Ù…ÙŠ =====
function toggleOrder(){
  orderYes.classList.toggle("hidden",hasOrder.value!=="Ù†Ø¹Ù…");
  orderNo.classList.toggle("hidden",hasOrder.value!=="Ù„Ø§");
}
function toggleCash(){
  cashYes.classList.toggle("hidden",hasCash.value!=="Ù†Ø¹Ù…");
  cashNo.classList.toggle("hidden",hasCash.value!=="Ù„Ø§");
}

function sendOld(){
  navigator.geolocation.getCurrentPosition(p=>{
    if(distance(localStorage.startLat,localStorage.startLng,p.coords.latitude,p.coords.longitude)>2000){
      msgOld.textContent="âŒ Ø®Ø§Ø±Ø¬ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©";
      return;
    }
    readImage(oldImage,img=>{
      fetch(URL,{
        method:"POST",
        body:JSON.stringify({
          type:"old",
          name:oldName.value,
          hasOrder:hasOrder.value,
          orderAmount:orderAmount.value,
          orderReason:orderReason.value,
          hasCash:hasCash.value,
          cashAmount:cashAmount.value,
          cashReason:cashReason.value,
          note:oldNote.value,
          image:img,
          lat:p.coords.latitude,
          lng:p.coords.longitude,
          visitDuration:visitDuration()
        })
      }).then(r=>r.json())
      .then(res=>msgOld.textContent="âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    });
  });
}
</script>
</body>
</html>
